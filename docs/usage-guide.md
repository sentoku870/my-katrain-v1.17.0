# myKatrain 使い方ガイド

> このガイドは myKatrain の基本的な使い方と、LLM（生成AI）との連携方法を説明します。

---

## 1. myKatrain とは

KaTrain の fork プロジェクトで、KataGo 解析結果を「カルテ（診断書）」形式で出力し、LLM を使った囲碁コーチングを効率化するツールです。

---

## 2. ユースケース4ルート

myKatrain と LLM を組み合わせる際の **4つの使い方** を整理します。

### ルート1: プロンプトのみ
- **入力**: 困りごとを文章で入力
- **用途**: 入口・方向づけ・行動ルール提示（最大3つ）
- **例**: 「序盤で打ち過ぎてしまう癖を直したい」

**特徴**:
- 最も手軽
- 一般論になりやすい
- 主観と実態のズレに気づきにくい

---

### ルート2: プロンプト + SGF or 画像
- **入力**: 困りごと + SGFファイル or 盤面画像
- **用途**: 「何が起きたか」の具体化
- **例**: 「この局面で黒が不利になった理由を知りたい」＋ SGF

**特徴**:
- 具体例があるので説明の質が 1.5〜2倍 向上
- SGF推奨（画像は補助）
- まだ「どの局面が重要か」は人間が選ぶ必要あり

---

### ルート3: プロンプト + 解析入りSGF（KataGo解析済み）
- **入力**: 困りごと + KataGo解析データ入りSGF
- **用途**: **非サポート（想定外）**

**⚠️ このルートは扱いません**

**理由**:
- 解析入りSGFは情報量が膨大（数百KB〜数MB）
- LLMに全文貼り付けると処理が重くなる
- 重要局面の抽出が手動になり、効率が悪い
- 「楽に見える」が、実際は学習効率が低い

**このルートが来たときの対応**:
> 解析入りSGFの全文は情報量が多すぎて、この手順では扱いません（想定外の入力です）。
> 代わりに次のどちらかでお願いします：
> 1) 解析なしのSGF（または盤面画像）＋困りごと1〜3行
> 2) myKatrain のカルテ（重要局面TopN＋サマリ）を貼付（最も精度が上がります）

---

### ルート4: プロンプト + カルテ（myKatrain）
- **入力**: 困りごと + myKatrain 出力のカルテ（Markdown）
- **用途**: **最推奨（想定通り）**
- **例**: 「直近10局のカルテを見て、次の5局で優先すべき課題を教えて」＋ summary.md

**特徴**:
- 相談の質が **2〜4倍以上** 向上（体感）
- 「致命点トップ3」が客観指標で確定
- 主観の悩みとデータのズレ（思い込み）を補正
- 次の5局で改善したかを検証できる（学習ループ化）

**カルテが上げる相談の質**:
- 文章のみ（ルート1） → 一般論
- SGFあり（ルート2） → 具体例が増えて 1.5〜2倍程度
- カルテあり（ルート4） → 重要局面TopN＋集計で **2〜4倍以上**

---

## 3. カルテの種類

myKatrain は2種類のカルテを出力できます。

### 3.1 単局カルテ（1局の診断書）
- **出力**: 現在の対局の重要局面・ミス分類・フェーズ別統計
- **用途**: 「この1局で何が起きたか」を振り返る
- **操作**: メニュー → Analysis → カルテ作成（予定）

### 3.2 複数局サマリー（Phase 6で実装済み）
- **出力**: 複数局の統計をまとめたレポート（summary.md）
- **用途**: 「直近N局の傾向」を把握する
- **操作**: メニュー → Analysis → 複数対局カルテ作成

---

## 4. カルテ駆動モードの推奨フロー

カルテを使ってLLMと相談する際の **短くて強い** フローです。

### Step 1: カルテから客観事実3点を抽出
例:
- 中盤に損失が集中している（序盤12.3目 / 中盤38.9目 / 終盤8.1目）
- 大悪手（blunder）が6回ある（全体の2.1%）
- 手の自由度が「狭い」局面で損失が多い（35件中12件が悪手以上）

### Step 2: 原因仮説は最大2つに絞る
例:
- 仮説1: 中盤の戦いで読み抜けが多い
- 仮説2: 形勢判断ミスで無理な攻めをしている

### Step 3: 主テーマ1つを決める（他は捨てる）
例:
- 主テーマ: 「中盤の戦いで、相手の弱点と自分の薄みを見極める」

### Step 4: 行動ルール最大3つ（次の5局で守る）
例:
1. 戦いの前に「自分の石は安全か？」を確認
2. 相手の弱点（呼吸点2以下）を見つけてから動く
3. 読みが不安なら、まず連絡・補強を優先

### Step 5: 検証指標2つ（次のカルテで確認）
例:
1. 中盤の平均損失が30目以下に減る
2. 大悪手（5目以上）が3回以下に減る

### Step 6: 主観とカルテがズレていれば指摘（質問は最大2つ）
例:
- 「序盤が弱い」と思っていたが、データでは中盤の損失が3倍多い
- 「なぜ中盤で損失が増えると思うか？」（反証質問）

---

## 5. 運用ルール（明文化）

### ルート3（解析もりもりSGF）は非サポート
- 解析入りSGFの全文貼り付けは扱わない
- 必ず **ルート2（SGF/画像）** か **ルート4（カルテ）** へ誘導する

### カルテの軽さを維持する
- カルテは「LLMに貼るための、軽くて客観的な証拠」
- 重要局面TopN + 集計だけで、PV（変化）は原則入れない（重くなるため）

### 学習ループを回す
- カルテ → 課題特定 → 行動ルール → 5局実践 → 再カルテ
- 1回の相談で「主テーマ1つ + 行動ルール最大3つ」に絞る

---

## 6. FAQ

### Q1: カルテは何局分あればいい？
- **直近10局**: 処方（次の5局で直す）に最適
- **直近50〜100局**: 傾向（癖の頻度、崩れる帯域）を把握

### Q2: カルテ無しでLLMに相談してもいい？
- はい、ルート1（プロンプトのみ）やルート2（SGF/画像）も有効です
- ただし、カルテを使うと相談の質が大幅に向上します

### Q3: 解析入りSGFを貼り付けたらダメ？
- ルート3は非サポートです
- 代わりにルート2（解析なしSGF + 困りごと）またはルート4（カルテ）を使ってください

### Q4: カルテの「importance」って何？
- 重要度スコア（損失の大きさ + 局面の難しさを加味）
- 高いほど「この手が勝敗を分けた」可能性が高い

### Q5: 複数局サマリーの「freedom」が全部UNKNOWNなのはなぜ？
- **複数局サマリー（SGF直接パース）では Freedom は計算されません**
- Freedom 計算には KataGo の候補手情報（candidate_moves）が必要
- SGF ファイルには candidate_moves が保存されていないため、復元不可能

**Freedom が使える場所**:
- 単局カルテ（リアルタイム解析時）← Phase 7 で実装予定
- KaTrain の対局中・検討中（Game オブジェクト経由）

**代替指標**:
- 複数局サマリーでは Phase × Mistake のクロス集計を使用
- 「中盤の大悪手」など、具体的な弱点を特定可能

---

## 7. 次のステップ

### Phase 6（現在）
- ✅ 複数局サマリー（summary.md）出力
- ✅ プレイヤーフィルタ
- ✅ ハンディ別カテゴリ分け

### Phase 7（予定）
- 構造解析（グループ・呼吸点・連絡点・切断点）
- 初心者向けコーチングヒント
- 手の自由度（freedom）実装

### Phase 8（予定）
- 棋力判定システム（Tier1-5）
- レーダー5軸（Opening/Fighting/Endgame/Stability/Awareness）

---

## 8. 参考資料

- `docs/design/phase6-karte-spec.md`: カルテの設計仕様
- `docs/01-roadmap.md`: ロードマップ
- `CLAUDE.md`: プロジェクト全体の概要

---

## 9. Post-54 (Phase 55–65) 新機能ガイド

### 9.1 棋風診断（Style Archetype）

**アクセス方法**: myKatrain → カルテ出力
**表示されない条件**: 解析データが不十分な場合

| タイプ | 特徴 | 推奨学習方針 |
|--------|------|-------------|
| 剛腕ファイター | 戦闘軸↑、安定性↓ | 形勢判断と収束タイミング |
| 宇宙建築家 | 序盤↑、終盤↓ | ヨセの精度向上 |
| 精密機械 | 終盤↑、戦闘↓ | 戦いの仕掛け方 |
| 忍者サバイバー | 安定性↑、序盤↓ | 布石研究 |
| AIネイティブ | 認識力↑ | バランス調整 |
| バランスマスター | 全軸均等 | 弱点軸の特定と補強 |

**Confidence値**: 上位2つのアーキタイプスコアの差から算出。値が高いほど判定が明確。

---

### 9.2 5軸レーダー（Skill Radar）

**アクセス方法**: myKatrain → スキルレーダー、またはカルテ内「Radar」セクション
**表示されない条件**: 分類データがない場合

| 軸 | 評価内容 |
|----|---------|
| Opening | 布石・定石選択 |
| Fighting | 戦闘・読み |
| Endgame | ヨセ・計算 |
| Stability | 局面安定化 |
| Awareness | 複雑局面認識 |

**Tier 1-5**:
- **Tier 5**: 最高評価
- **Tier 1**: 要改善

> ⚠️ Tierは相対的な評価バンドであり、直接的な段級位への換算ではありません。

---

### 9.3 時間分析（Pacing & Tilt）

**アクセス方法**: myKatrain → カルテ出力 →「Time Management」セクション
**表示されない条件**: SGFに時間タグ（BL/WL）がない場合

| マーク | 意味 |
|--------|------|
| 🐇 | 早打ち（メディアンより大幅に短い） |
| 🐢 | 長考（メディアンより大幅に長い） |
| 🔥 | ティルトエピソード中の手 |

**ティルトエピソード**: 大きな損失が連鎖的に発生した区間を検出します。
- トリガー手の後、一定ウィンドウ内で損失が続くとエピソードとして記録
- 正の損失データが少なすぎる場合は検出を無効化

> 閾値・ウィンドウサイズは現在のヒューリスティック値であり、将来変更される可能性があります。

---

### 9.4 リスク管理分析（Risk Context）

**アクセス方法**: myKatrain → カルテ出力 →「Game Management」セクション
**表示されない条件**: 形勢判定に十分なデータがない場合

**形勢判定**:
- **WINNING**: 優勢（勝率・リードが一定以上）
- **LOSING**: 劣勢（勝率・リードが一定以下）
- **CLOSE**: 接戦（それ以外）

**振る舞い分類**:
| 振る舞い | 意味 |
|---------|------|
| Solid | 形勢安定を優先 |
| Risk Taker | 複雑化を狙う |
| Fighter | 劣勢から積極的に戦う |
| Resigned | 劣勢で消極的 |

**(estimated) ラベル**: 一部のデータが欠落しており、代替推定を使用した場合に表示されます。

> ⚠️ 形勢判定の閾値は現在のヒューリスティックであり、置碁や序中盤では判定が不安定になることがあります。

---

### 9.5 開発者向け参照: 棋譜スコアリング（Curator）

> ⚠️ **この機能はUIが未実装です**（JSON出力のみ）。一般ユーザー向けではありません。

**生成条件**: バッチ処理をプログラム的に呼び出す（`generate_curator=True`）

**出力ファイル（例）**:
- `curator_ranking_*.json`: 棋譜適性ランキング
- `replay_guide_*.json`: 学習ガイド用ハイライト局面

> 実際のファイル名・出力先は実行ログまたは設定で確認してください。

**主要フィールド**:
- `score_percentile`: バッチ内での相対順位
- `needs_match`: ユーザー弱点軸との関連度
- `recommended_tags`: 改善ポイントのタグ

この機能の詳細については、`katrain/core/curator/` のソースコードを参照してください。
