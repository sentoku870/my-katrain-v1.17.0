# 棋力判定（5区分）＋学習ループ：1枚仕様（v1.1 仮閾値つき）

作成日: 2025-12-29  
用途: 囲碁AI教育（myKaTrain 統合想定）

---

## 0. 前提（安全運用）
- 外向きUI/資料では、特定ブランド名・公式認定を想起させる表現を使わない（独自評価として扱う）。
- 外部サイトの文章/画像/図表/スクショは再掲しない（要約＋リンク、図は自作）。
- 解析対象は「ユーザーが自発的にアップロードしたSGF」または「オープンなSGFコーパス」に限定する。

---

## 1. 目的
- 勝敗ではなく“着手の質”を中心に、初心者〜アマ強豪を5区分で見える化し、学習ループ（診断→課題→練習→再評価）に落とす。

---

## 2. 入力と解析（推奨の固定条件）
- 入力: SGF（盤サイズ/コミ/ハンディ/ルールを抽出）
- 解析: KataGo（例: 各手500〜1000 visits）で `scoreLoss` / `scoreStdev` / `policyTopN` 等を取得
- 注意: 盤サイズ（9路/13路/19路）とハンディ戦はスコア分布が大きく変わるため、Tier判定は原則「19路・互先」から開始。

---

## 3. コア指標（定義）
- **APL（Average Point Loss）**: 手ごとの `scoreLoss` の平均（AI最善手との差を目数で測る）
- **Adjusted APL（adj_apl）**: 大悪手の歪みを抑えるためキャップCを入れ、局面の難しさを重み `w_i` で補正して平均化  
  - 例: `adj_apl = (1/N) Σ w_i * min(scoreLoss_i, C)`
  - 既定値（仮）:
    - `C = 30`
    - `w_i = clamp(scoreStdev_i / 8, 0.7, 1.3)`
- **Blunder Rate**: `scoreLoss_i >= 5`（既定）の割合（安定性の基礎）
- **Move Agreement**: Top-1 一致率（補助。モデルや設定で変動するため重みは低め）
- **Phase Split**: 序盤/中盤/終盤に分けて別集計（例: 1-50 / 51-150 / 150+）

---

## 4. Tier判定：仮閾値（v0）
まずは `adj_apl` を主軸にTierを決め、Blunder/Awarenessで ±1 段だけ補正する。数値は**“仮”**で、校正で確定する。

### 4.1 仮閾値（19路・互先前提）
| Tier（外向き） | adj_apl（主判定） | blunder_rate（>=5点） | agreement_top1 | 注 |
|---|---:|---:|---:|---|
| Tier1 初心者 | > 2.0 | > 0.20 | < 0.08 | まず大きな損を減らす |
| Tier2 中級 | 1.2 – 2.0 | 0.12 – 0.20 | 0.08 – 0.12 | 形と安全第一 |
| Tier3 有段 | 0.7 – 1.2 | 0.06 – 0.12 | 0.12 – 0.18 | 読み抜けを減らす |
| Tier4 高段 | 0.4 – 0.7 | 0.03 – 0.06 | 0.18 – 0.26 | 形成判断＋終盤精度 |
| Tier5 アマ強豪 | < 0.4 | < 0.03 | >= 0.26 | 致命傷がほぼ無い |

### 4.2 補正ルール（簡易・最大±1段）
1. `adj_apl` で暫定Tierを決定  
2. 補正（±1段）
   - `blunder_rate` が同Tierの上限を大きく超える → **-1**（安定性不足）
   - `agreement_top1` が同Tierの下限を大きく下回る → **-1**（形/感覚不足）
   - 逆に `blunder_rate` が1段上の水準かつ `agreement_top1` も満たす → **+1**（上振れ確認）

---

## 5. 安定化（運用）
- 1局で確定せず、直近20局程度の指数平滑移動平均（EMA）でTierを安定化。
- トレンド検出: 直近10局で `adj_apl` が一定幅以上改善したら昇級候補。
- 序盤/中盤/終盤のどこが原因かは「レーダー5軸＋phase別APL」で特定する。

---

## 6. 校正（Calibration）手順：仮→確定
- **Step A（開始〜20局）**: 上の仮閾値でTier表示。`confidence` は低め（例: 0.55固定）
- **Step B（20局〜）**: ユーザの `adj_apl` 分布（中央値・四分位）を計算し、境界を **±0.1〜0.2**点範囲で微調整
- **Step C（50局〜）**: 互先19路だけに絞った分布で再校正。必要なら盤サイズ/ハンディ別に別モデルを持つ。
- 推奨: ‘自認棋力’（例：KGS/野狐/OGSの自己申告）を任意入力にして、初期境界の微調整に使う（表示には使わない）。

---

## 7. レーダー5軸（0-100）
- **Opening**: 1-50手の平均目数損（低いほど高得点）
- **Fighting**: 高分散（難解）局面での目数損（低いほど高得点）
- **Endgame**: 150手以降の平均目数損（低いほど高得点）
- **Stability**: 5目以上損の手の割合（少ないほど高得点）
- **Awareness**: AI最善手との一致率（高いほど高得点）

---

## 8. 出力（JSON骨子）
```json
{
  "gameId": "uuid",
  "tier": {"label": "Tier3", "confidence": 0.72},
  "metrics": {"adj_apl": 0.93, "blunder_rate": 0.06, "agreement_top1": 0.18},
  "radar": {"opening": 62, "fighting": 48, "endgame": 70, "stability": 55, "awareness": 40},
  "focus": {"primary": "Stability", "next_action": "形/呼吸点の確認ドリル"}
}
```

---

## 9. myKaTrain統合MVP（最小セット）
1) SGF取り込み  
2) KataGoバッチ解析  
3) メトリクス計算  
4) 進捗DB保存  
5) JSON出力  
6) レーダー表示  
7) ミス抽出＋短い課題提示  
