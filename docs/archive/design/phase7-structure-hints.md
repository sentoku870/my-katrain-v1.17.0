# myKatrain 有段者/初心者の狙いと「構造の言語化パーツ」整理メモ（草案）

## 1. 目的（このメモの役割）
- 有段者向け・初心者/初級者向けで「やりたいこと」を混線させずに整理する。
- 両者に共通で効く **構造の言語化パーツ**（呼吸点/連絡/切断…）を「共通基盤」として定義し、後続機能の土台にする。
- 実装前に **何を固定し、何を後で調整するか** を決めて、無駄な設計コストを減らす。

---

## 2. ターゲット整理

### 2.1 有段者（メイン）
**欲しい価値**
- 検討の効率化（読む量を減らす／重要局面に早く到達）
- 根拠のある指摘（損失・変化・形勢の転換点）
- 「なぜ悪いか」の再現可能な説明（次に同じミスを減らす）

**困りごと（典型）**
- 候補手が多すぎる局面で、読むべき筋が散らばる
- ミスの理由が「雰囲気」だと納得できない（再現性がない）

**成功条件（体感）**
- Top3〜5の重要局面だけ見れば、学びがある
- 「薄み・切り・連絡・呼吸」など構造タグで理由が短く通る

### 2.2 初心者・初級者（サブ。ただし救済対象）
**欲しい価値**
- いま何を優先すべきか（逃げる/つなぐ/守る/攻めるの順番）
- 「正解手」より **考え方の型**（チェックリスト）
- 心理的安全（キツい断定より、改善の道筋が見える言い方）

**困りごと（典型）**
- 未完成の石（不安定な石）が分からない → 逃げ回って棒石になりがち
- 二眼の見立てが付かない → 形が崩れて死ぬ

**成功条件（体感）**
- 盤面のどこが危険かが一目で分かる
- 「まずこれ」(1行) + 「見る順番」(3点) + 「NG」(1点) が毎局出る

---

## 3. 設計方針（混線を防ぐルール）

### 3.1 二階建て設計
- **共通基盤**：構造の言語化パーツ（盤面特徴の抽出）
- **表示/出力**：
  - 有段者モード：重要局面・根拠・短い理由タグ
  - 初心者モード：最優先1行＋チェックリスト＋NG警告

### 3.2 「正解手」より「選別」を重視
- 有段者：読むべき筋の選別（切り/連絡/薄み絡みを先に）
- 初心者：今やるべきことの選別（危険石→連絡→眼形の種）

### 3.3 LLMは後付け可能にする
- 最初はテンプレで成立させる（安定・高速）
- LLMは「テンプレの穴埋め」「言い換え」など限定的に使う

---

## 4. 構造の言語化パーツ（共通基盤）の定義

### 4.1 目的
- 盤面の状態を **人間が理解しやすい語彙**に落とし、UIと説明の共通言語にする。
- これがあると、
  - 初心者：危険箇所の可視化、優先順位が立つ
  - 有段者：重要局面の理由が短く通る、読む筋を絞れる

### 4.2 最小セット（まず入れる：v0）
**A. グループ（連結塊）**
- `group_id`：連結成分ID
- `color`：黒/白
- `stones`：座標配列
- `liberties_count`：呼吸点数
- `liberties_points`：呼吸点座標集合（UI表示用。数が多ければ省略可）
- `is_in_atari`：呼吸点1（アタリ）
- `is_low_liberty`：呼吸点2（危険）
- `adjacent_enemy_groups`：隣接する敵グループID（攻防の候補）

**B. 点（空点）**
- `connect_points`：自分の別グループ同士を繋げる可能性が高い点（下の定義参照）
- `cut_points`：相手に打たれると分断されやすい点（下の定義参照）

> v0の思想：
> - 「切られて困る」「繋がって助かる」「呼吸が足りない」をまず可視化する。
> - 眼形・死活の厳密判定は **入れない**（後回し）。

### 4.3 点の定義（判定ルール：まずは粗く・安定優先）

#### 4.3.1 連絡点（connect_points）
候補点 `p` が空点で、次を満たすなら「連絡点候補」とする。
- `p` に隣接する自分石が **2グループ以上**（= そこに打つと接続が起きうる）
- その接続で、少なくとも一方のグループの `liberties_count` が改善する（例：+1以上）

優先度（表示順位）
- `liberties_count` が 1〜2 のグループ同士を繋げる点を最上位
- それ以外は次点（候補として薄く表示）

#### 4.3.2 切断点（cut_points）
候補点 `p` が空点で、次を満たすなら「切断点候補」とする。
- `p` が「2つの自分グループの間の急所」に見える（例：自分石が `p` を挟んで対角/二間に分かれており、相手が `p` に先着すると接続が難化する）
- さらに、その分断後に **少なくとも片方**が `liberties_count <= 2` になりやすい（脆い）

> 実装メモ：
> - 最初は「形の厳密判定」より、
>   - “この点が埋まると自分の連絡点が消える”
>   - “分断された片方が呼吸2以下”
>   のような **影響ベース**で出すのが安定。

### 4.4 危険度のスコア（初心者支援に直結する簡易指標）
グループ危険度 `danger_score`（0〜100）を置く。
- ベース：呼吸点
  - 呼吸1：+60
  - 呼吸2：+35
  - 呼吸3：+15
- 切断リスク：+0〜20（近傍の `cut_points` 数や、連絡点が少ないほど加点）
- 石数補正：大石ほど少し加点（例：石数>=6で+5、>=10で+10）

> 目的：数値の正確さではなく「優先順位を安定して出す」こと。

### 4.5 追加セット（v1以降：効果が高い順）
- `shape_warning`（棒石/陣笠の兆候）
  - 厳密検出ではなく、例えば「同方向へ連続して逃げ」「目形の候補が増えてない」等の兆候で十分
- `eye_candidates`（眼の候補地）
  - まずは「候補が2つ以上あるか？」の粗い推定（角・ふくらみ・相手の急所付近など）
- `ko_seki_hint`（コウ/セキの兆候）
  - 初期は「注意ラベル」だけでも可

---

## 5. どう表示するか（UI）

### 5.1 初心者向け：サイドパネル（固定）
毎局ここだけ出ればよい（過不足を抑える）
1) 最優先（1行）
2) 危険グループ（最大2つ：場所＋理由1行）
3) 見る順番（チェック3点）
4) 候補手（最大3：おすすめ表現、正解と言わない）
5) NG（1点：棒石/無理出し等）

### 5.2 有段者向け：理由タグ（短く）
- 重要局面のカードに **構造タグ**を付ける
  - 例：`cut` `connect` `thin` `atar i` `liberties_low`
- PV/損失の根拠は従来通り。理由を長文にしない。

---

## 6. どう使うか（ロジック）

### 6.1 初心者テンプレ選択（症状→処方箋）
- `panic_escape`（逃げ回って棒石）
- `unfinished_group`（未完成が多い）
- `too_many_cuts`（切断点が多い）
- `simple_safety_first`（まず繋ぐ・守る）

選択材料は「構造パーツ＋KataGo上位候補」で足りる。

### 6.2 有段者：重要局面の“理由の自動分類”
- 重要局面で「何が変わったか」を構造パーツでタグ化
  - 例：切断が放置された／連絡を逃した／呼吸が急減した

---

## 7. 最小実装プラン（段階）

### Step 1：抽出だけ（共通基盤）
- グループ生成
- 呼吸点数
- アタリ/危険
- 連絡点/切断点候補

**受け入れ条件**
- 盤上の危険グループ（呼吸1〜2）が人間の感覚と大きくズレない

### Step 2：表示（初心者サイドパネル＋軽いマーク）
- サイドパネルに「最優先1行＋危険2つ」を出す
- 盤面に小さなマーク（危険グループ枠、切断点に印）

### Step 3：テンプレ化（チェックリスト＋NG）
- 症状別テンプレ10個程度
- 表現はテンプレで固定（まず安定）

### Step 4：有段者カードへの接続（理由タグ）
- 重要局面カードにタグ表示
- 後でLLMを繋ぐなら、タグ＋根拠を入力にする

---

## 8. 「もっと詰めた方が良いか？」の結論

### 8.1 今、詰めると得する（固定していい）
- **共通基盤の範囲**：呼吸点/連絡/切断/危険 の最小セット
- **出力の形**：初心者は“5枠固定”、有段者は“タグ短文”
- **調整可能にする方針**：閾値・文言・テンプレはデータ外出し

### 8.2 今、詰めすぎない方が良い（後で回す）
- 眼形・死活の厳密判定（重くて沼りやすい）
- 棒石/陣笠の厳密検出（兆候で十分）
- 初心者テンプレの網羅（10個で走り、追加は運用で）

---

## 9. 次アクション候補
- この草案を `docs/` の「開発メモ」枠に置く（ファイル名は日付＋topic）
- Step1（抽出）を最小実装し、サイドパネルで“危険2つ”だけ先に出す
- その後、テンプレ10個をYAML化して調整ループに入る



---

## 10. 理由タグ一覧（v0：定義と発火条件）

> 目的：長文説明を避け、**短い理由**で「何が起きているか」を共有する。
> - 初心者：タグ→テンプレ分岐に使う
> - 有段者：重要局面カードの理由ラベルに使う

### 10.1 タグ（v0）
- `atari`：自分（または相手）の主要グループが呼吸1
  - 発火：`exists(group.is_in_atari == True)`
- `low_liberties`：主要グループが呼吸2以下（危険）
  - 発火：`max_danger_group.liberties_count <= 2`
- `cut_risk`：切断点が多い／切られると危険グループが生じる
  - 発火：`len(cut_points_near_urgent_group) >= 1` かつ `danger_score`高
- `need_connect`：連絡点があり、繋げば危険度が大きく下がる
  - 発火：`exists(connect_point that merges >=2 friendly groups)` かつ `danger_score改善 >= 20`
- `thin`：守りが薄い（危険グループはないが切断/連絡が多い）
  - 発火：`max_liberties >= 3` だが `cut_points_total` 多め（例：>=3）
- `chase_mode`：相手の危険グループがあり攻めが有効
  - 発火：`enemy_max_danger_score >= threshold` かつ `my_urgent_group`が安全（例：呼吸>=3）
- `too_many_choices`：候補手が散らばり、優先順位が必要
  - 発火：KataGo上位候補が複数方角に分散（簡易でOK：上位3の距離が全て大きい等）
- `endgame_hint`：終盤っぽい（初期は推定でOK）
  - 発火：盤上の空点が少ない／ヨセ候補が多い（後回しでOK）

### 10.2 タグ優先順位（表示の並び）
- 初心者：`atari` > `low_liberties` > `need_connect` > `cut_risk` > `thin` > `chase_mode` > `too_many_choices` > `endgame_hint`
- 有段者：局面理由のラベルとして複数併記可（最大3）

---

## 11. 初心者テンプレ10個（v0：ID＋本文）

> 形式：**5枠固定**（最優先1行 / 危険2つ / チェック3 / 候補手3 / NG1）を崩さない。
> - テンプレは「症状→処方箋」
> - 正解手とは言わない（おすすめ／有力）
> - 断定を避ける（〜しそう／〜になりやすい）

### 11.1 テンプレ一覧

#### T01: `panic_escape`（逃げ回り・棒石になりがち）
- 最優先：`{urgent_group} を“逃げ続ける”より、形を整えて生き筋を作る。`
- チェック：
  1) 連絡点 `{connect_point}` で繋げる？
  2) 逃げるなら「曲がり・コスミ」で目形の種を増やせる？
  3) 切断点 `{cut_point}` を放置してない？
- 候補手：`{move1}` / `{move2}` / `{move3}`
- NG：`同じ方向に一直線で逃げ続ける（棒石になりやすい）`

#### T02: `save_atari`（アタリ対応が最優先）
- 最優先：`{urgent_group} がアタリ。まずは取られない形にする。`
- チェック：
  1) 呼吸を増やす手はある？（当て／ツケ／伸び）
  2) 連絡で助かる？ `{connect_point}`
  3) 取って解決する手はある？（取り合い）
- 候補手：`{move1}` / `{move2}` / `{move3}`
- NG：`アタリ放置で別の場所に打つ`

#### T03: `urgent_connect`（繋げば一気に安定）
- 最優先：`{connect_point} で繋ぐと、{urgent_group} の危険が大きく減る。`
- チェック：
  1) 繋いだ後の呼吸は増える？
  2) 相手の切断を防げる？
  3) 繋いだ後に“次の守り”が必要？
- 候補手：`{move1}` / `{move2}` / `{move3}`
- NG：`繋げる形なのに逃げ続ける`

#### T04: `cut_warning`（切られどころが多い）
- 最優先：`切断点 {cut_point} が急所。ここを意識して形を崩さない。`
- チェック：
  1) 切断点を消す（ツギ/ノビ）で安定する？
  2) 切られても片方は生きる？
  3) 相手の切りを誘って取れる筋はある？（有段寄りの次点）
- 候補手：`{move1}` / `{move2}` / `{move3}`
- NG：`薄いまま手抜きして切られる`

#### T05: `unfinished_group`（未完成の石が主原因）
- 最優先：`いまは“未完成の石”を減らすのが先。{urgent_group} をまず安定させる。`
- チェック：
  1) 連絡で石が一団になる？
  2) 目の候補地は2つある？（角/ふくらみ/相手の急所）
  3) 相手に先手で迫られる所はどこ？
- 候補手：`{move1}` / `{move2}` / `{move3}`
- NG：`未完成のまま攻めに走る`

#### T06: `attack_when_safe`（自分が安全なら攻めが有効）
- 最優先：`自分は比較的安全。{enemy_urgent_group} を攻めて得をする方針が合いそう。`
- チェック：
  1) 相手の呼吸/目形の急所はどこ？
  2) 追い過ぎて自分が薄くならない？
  3) 利益（地/厚み/先手）を決めて攻める
- 候補手：`{move1}` / `{move2}` / `{move3}`
- NG：`“取るまで追う”に固執する`

#### T07: `simplify`（読み負担を減らす）
- 最優先：`複雑にするとミスが出やすい。まずは形を単純化して安全を確保する。`
- チェック：
  1) 連絡・補強で弱点を減らす
  2) 相手の切り筋を消す
  3) 先手を取って大場へ
- 候補手：`{move1}` / `{move2}` / `{move3}`
- NG：`筋が多い戦いを自分から増やす`

#### T08: `too_many_choices`（何から見ればいい？）
- 最優先：`候補が散っている。まずは“危険→連絡→大場”の順で見る。`
- チェック：
  1) 危険グループは？ `{urgent_group}`
  2) 連絡点は？ `{connect_point}`
  3) それでも大丈夫なら大場（広い所）
- 候補手：`{move1}` / `{move2}` / `{move3}`
- NG：`大場から入って切られて困る`

#### T09: `shape_build`（形を作る：目形の種）
- 最優先：`生きるには“形”が必要。{urgent_group} に目形の種を増やす。`
- チェック：
  1) コスミ/曲がりで目の候補地を作れる？
  2) 相手の急所（眼を潰す点）を先に取られてない？
  3) 連絡して形を共有できる？
- 候補手：`{move1}` / `{move2}` / `{move3}`
- NG：`形が育たない伸び一辺倒`

#### T10: `endgame_basic`（ヨセ：初心者用の基本）
- 最優先：`終盤は“確実に増える所”を先に。大きいヨセ→小さいヨセの順。`
- チェック：
  1) 一手で確実に増える所はどこ？（境界線の押さえ/ハネ）
  2) 先手で終わるヨセを優先
  3) 危険が残っていないかだけ確認
- 候補手：`{move1}` / `{move2}` / `{move3}`
- NG：`細かい手に走って大きい所を逃す`

---

## 12. 設定YAML雛形（v0：閾値/表示件数/モード）

> 狙い：初心者向けの調整（閾値・文言）を **コードから切り離す**。

```yaml
# config/coach_hints_v0.yaml
schema_version: 0

modes:
  beginner:
    enabled: true
    panel:
      show_priority_line: true
      max_danger_groups: 2
      checklist_items: 3
      max_suggested_moves: 3
      show_ng: true
    tag_priority:
      - atari
      - low_liberties
      - need_connect
      - cut_risk
      - thin
      - chase_mode
      - too_many_choices
      - endgame_hint
    template_default: too_many_choices

  dan:
    enabled: true
    card:
      max_reason_tags: 3
      show_reason_tags: true

thresholds:
  danger:
    atari_liberties: 1
    low_liberties: 2
  cut_risk:
    min_cut_points_near_urgent: 1
    min_total_cut_points_for_thin: 3
  connect:
    min_danger_improvement: 20
  chase_mode:
    enemy_danger_score_min: 60
    my_min_liberties: 3

scoring:
  danger_score:
    liberties:
      1: 60
      2: 35
      3: 15
    cut_risk_bonus_max: 20
    size_bonus:
      stones_ge_6: 5
      stones_ge_10: 10

templates:
  # まずは内蔵でもOK。将来は外部yamlへ切り出せる形
  builtin: true
  ids:
    - panic_escape
    - save_atari
    - urgent_connect
    - cut_warning
    - unfinished_group
    - attack_when_safe
    - simplify
    - too_many_choices
    - shape_build
    - endgame_basic
```

---

## 13. テンプレ変数仕様（v0：実装で埋める項目）

> 目的：テンプレの穴埋めがブレないように「変数の意味」を固定する。

- `{urgent_group}`：最も危険度が高い自分グループの短い表現
  - 例：`左上の黒（大石）` / `中央の白` など
- `{enemy_urgent_group}`：相手側で危険度が高いグループ
- `{connect_point}`：優先度が最も高い連絡点（なければ `なし`）
- `{cut_point}`：最も危険度に効いている切断点（なければ `なし`）
- `{move1}` `{move2}` `{move3}`：おすすめ候補手（KataGo上位から）
  - 表記例：`Q10（つなぎ）` のように、座標＋短い役割ラベル

> 注意：
> - 断定語を避けるため、役割ラベルは「〜しやすい」「〜を狙う」寄りにする。
> - `{connect_point}` / `{cut_point}` が `なし` の場合、文が破綻しないようテンプレ側で言い回しを用意する（将来調整）。

