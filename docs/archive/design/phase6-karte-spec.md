# myKatrain「カルテ」設計まとめ（本チャットから抽出・構造化）

作成日: 2025-12-31（Asia/Tokyo）

このドキュメントは、今回のチャットで話した **「カルテ」**に関する内容を、実装と運用に使えるように整理したものです。  
前提は「野狐4段（中段・伸び悩み帯）」を基準にし、後から棋力別に微調整していく方針です。

---

## 0. 結論（運用の最適解）

- 生成AI（LLM）は **囲碁の一般理解・典型ミスの説明**は強いが、**1手1手の最善手の断定**は弱い。
- したがって「有段者の精度を上げる」には、LLMではなく **KataGo由来の要約（＝カルテ）**を渡すのが最も効く。
- ただし KaTrain フォークは多くの人が使わないため、**フォークを必須にしない二層構造**が最適。

> 入口（誰でも）＝プロンプト運用  
> 上位（精度が要る人だけ）＝mykatrain の「カルテ」を添付して相談

---

## 1. ユースケースの4ルート（あなたの運用方針）

あなたの整理は妥当で、かつプロジェクトをブレさせない「最適な分割」です。

1. **プロンプトのみ**  
   - 入口・方向づけ・行動ルール提示（最大3）
2. **プロンプト＋SGF or 画像**  
   - 「何が起きたか」の具体化（SGF推奨、画像は補助）
3. **プロンプト＋既存のKataGo解析結果もりもりSGF**  
   - **非サポート（想定外）**  
   - 理由: 重い入力をそのまま貼る“楽”運用になりやすく、安定運用と目的に反する
4. **プロンプト＋カルテ（mykatrain）**  
   - **最推奨（想定通り）**  
   - 証拠主導で、会話の質と再現性が大幅に上がる

### 3をサポートしない運用ルール（明文化推奨）
- 解析入りSGFの全文貼り付けは扱わない  
- 必ず **2（SGF/画像）**か **4（カルテ）**へ誘導する

#### 3が来たときの定型返信（コピペ用）
> 解析入りSGFの全文は情報量が多すぎて、この手順では扱いません（想定外の入力です）。  
> 代わりに次のどちらかでお願いします：  
> 1) 解析なしのSGF（または盤面画像）＋困りごと1〜3行  
> 2) mykatrain のカルテ（重要局面TopN＋サマリ）を貼付（最も精度が上がります）

---

## 2. 「カルテ」とは何か（このプロジェクトでの定義）

### 2.1 解析ログとカルテの違い
- **解析ログ（もりもりSGF含む）** = 素材の倉庫（重い・散らばる・比較しづらい）
- **カルテ** = 教育用に圧縮されたダイジェスト（軽い・焦点が定まる・比較できる）

カルテは「AIに貼る」ための **短い入力（証拠）**として設計する。

### 2.2 カルテが上げる“相談の質”
- 文章のみ → **一般論**になりやすい
- SGFあり → 具体例が増えて **1.5〜2倍程度**
- カルテあり → 重要局面TopN＋集計で **2〜4倍以上**（体感）  
  - 「致命点トップ3」が客観指標で確定
  - 主観の悩みとデータのズレ（思い込み）を補正
  - 次の5局で改善したかを検証できる（学習ループ化）

---

## 3. 野狐4段基準：有段者プロンプトは「2モード化」が最適

### 3.1 カルテ無しモード（ルート1/2）
目的: 迷子の解消／一般論の中で主テーマを1つに絞る

- 主テーマ: 1つ
- 行動ルール: 最大3つ
- 質問は最小（最大2つ）
- 反証質問（思い込み確認）を1つ入れる

### 3.2 カルテ駆動モード（ルート4）
目的: **証拠（カルテ）→原因特定→処方→検証** を最短で回す

#### 推奨フロー（短くて強い）
1) カルテから **客観事実3点**（例: 中盤に集中、勝ち局面で急落、自由度が高い局面で落とす等）  
2) 原因仮説は **最大2つ**に絞る  
3) **主テーマ1つ**を決める（他は捨てる）  
4) 行動ルール **最大3つ**（次の5局で守る）  
5) 検証指標 **2つ**（次のカルテで確認）  
6) 主観（困りごと）とカルテがズレていれば指摘し、質問は最大2つ

---

## 4. mykatrain の「カルテ」はどうあるべきか（野狐4段：CardSpec v0）

### 4.1 目標
- **軽い**（LLMに貼っても重くない）
- **安定**（毎回同じ項目が出る）
- **教育向け**（重要局面・損失構造・再現性を見せる）
- **“1手1手の最善”を全部はやらない**（必要なら次段階）

### 4.2 カルテの最小フィールド（CardSpec v0）
以下が「最小で強い」セット。

#### A) メタ
- 対象: 単局 or 直近N局（推奨: 10局）
- 期間: 日付（SGFのDTがあれば）  
- ルール: 19路 / 互先 or 置碁 / コミ
- 解析条件（簡易で良い）: preset名（easy/normal/strict 等）

#### B) 集計（“結果”より“損の構造”）
- 序盤/中盤/終盤の損失傾向（ざっくり）
- 「勝ち局面から落とす」 vs 「負け局面で粘れない」などの傾向（可能なら）
- ミス分類（良/軽/悪/大悪 等）があるなら分布
- 「手の自由度（広い/普通/狭い/一択）」があるなら分布

#### C) 重要局面 TopN（核）
各エントリに最低限載せる:
- game_id（ファイル名でOK）
- move_no / to_play（B/W）
- points_lost（または同等の損失指標）
- importance（重要度）
- miss_severity（良/軽/悪/大悪 等、あるなら）
- freedom（広い/普通/狭い/一択＋スコア、あるなら）
- （任意）座標 / 実戦手 / 推奨手（出せるなら）

> PV（変化）や候補手は v0 では原則入れない（重くなるため）。  
> 必要なら v1 以降で「上位3件だけPV」などに限定する。

### 4.3 重要局面の量の目安（野狐4段）
- 1局あたり重要局面が **10〜25件**程度になるのが扱いやすい  
  - 多すぎ: ノイズが多い（閾値が低い）
  - 少なすぎ: 学習材料不足（閾値が高い）
- preset は初期は normal/strict を推奨（実測で調整）

---

## 5. 直近10局 vs 50〜100局（“量”の設計ルール）

### 5.1 原則
- 「多ければ多いほど良い」は **傾向把握には有利**だが、無限に増やすのが最適ではない
- ノイズ増・鮮度低下・混在条件（置碁/互先/早碁/路盤）が問題になる

### 5.2 最適な二段構え（おすすめ）
- **少量（直近10局）**: 処方（次の5局で直す）  
- **大量（直近50〜100局）**: 傾向（癖の頻度、崩れる帯域、自己申告ズレ）

### 5.3 低頻度ユーザー対策
- 「直近10局」だと期間が伸びすぎる人には  
  **直近30日で最大N局**の期間固定が有効

---

## 6. 日付（DT）と「打ちすぎ検知」をカルテに入れるか

### 6.1 日付が取れるなら有効
- 野狐SGFはDT（対局日）が入っていることが多い想定
- DTが無い局は「不明」として扱い、統計の母数を明記する

### 6.2 “打ちすぎ”は断定しない（提案レベル）
カルテに入れるなら、断定ではなくシグナルとして扱う。

- 直近7日: 局数 / 1日平均 / 1日最大
- 同日後半ほどミスが増える傾向（可能なら）
- 提案文:  
  - 「このペースだと復習が追いつきにくい可能性」  
  - 「同日後半に悪手が増えるなら局数を減らす価値」

---

## 7. mykatrain 実装：最小で価値が出るステップ（おすすめ順）

### ステップ1：カルテv0のフォーマットを固定（CardSpec v0）
- まずは Markdown 1枚に固定
- 重要局面TopN＋集計＋メタ、だけ（PVなし）

### ステップ2：「Export/Copy Karte」導線を1つ作る
- メニュー or ボタンで **1クリック**で出せる
- クリップボードにコピー or .md 保存（どちらでも）

### ステップ3：直近10局カルテ（オプション）
- 単局が安定したら、直近10局まとめを追加
- 条件（互先/置碁、路盤、時間帯）を揃えるフィルタを最小で用意

### ステップ4：プロンプト側に「カルテ駆動モード」を追加
- 既存の有段者プロンプトを壊さずに分岐だけ追加
- 3（解析もりもりSGF）は非対応として明記し、2/4へ誘導

### ステップ5：実測で閾値調整（preset）
- 重要局面件数が多すぎ/少なすぎだけを見て調整
- 最初は「安定」を優先（精密さは後でOK）

---

## 8. “カルテ貼り付け用”の雛形（Markdown）

以下は、mykatrain が吐く Markdown の「形」の例です（内容は v0）。

```markdown
# AI Karte v0
target: last_10_games
preset: normal
generated_at: 2025-12-31

## Meta
- games: 10 (DT known: 10 / unknown: 0)
- rule: 19x19, even, komi: 6.5

## Summary
- phase_loss: opening 12.3 / middle 38.9 / end 8.1
- miss_severity_count: good 210 / light 55 / bad 18 / blunder 6
- freedom_count: wide 40 / normal 120 / narrow 35 / forced 9

## Important Moments (Top 20)
| game_id | move | to_play | points_lost | importance | severity | freedom |
|---|---:|:---:|---:|---:|---|---|
| g1.sgf | 87 | B | 9.2 | 9.2 | blunder | forced(0.85) |
| g3.sgf | 142 | W | 6.1 | 6.1 | bad | narrow(0.55) |
...
```

---

## 9. 将来（v1+）で足すと強いが、v0では不要なもの
- 推奨手（best move）と「代案3つ」
- PV（変化）※上位3件だけ等に限定推奨
- タグ分類（連絡不全/無理切り/守りすぎ/大場逃し/ヨセ雑…）
- 初心者向け導線（SGFが難しい人向け）

---

## 10. 次のアクション（あなた向けToDoチェックリスト）

- [ ] CardSpec v0（項目・順番・上限）を確定
- [ ] mykatrain に「Export/Copy Karte」を追加
- [ ] 直近10局カルテを試作（互先固定）
- [ ] 野狐4段として、カルテ駆動プロンプトで相談を実験（出力が安定するか）
- [ ] 重要局面件数が多すぎ/少なすぎなら preset を調整
- [ ] 次に棋力別調整（8〜4級 / 1〜2段 / 5段以上）へ拡張

---

## 付記：設計の芯（ブレないための一文）
- **カルテは「AIに貼るための、軽くて客観的な証拠」**  
- **プロンプトは「証拠から主テーマを1つに絞り、行動ルール3つで学習ループを回す」**
