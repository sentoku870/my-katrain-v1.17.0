# 変更履歴（CHANGELOG）

> このファイルは myKatrain の Phase 1-113 の変更履歴を記録しています。
> CLAUDE.md から分離されました（2026-01-24）。

---

- 2026-02-02: Phase 113 完了（Python 3.11 Modern Syntax Migration）
  - Legacy typing（`Optional[X]`, `List[X]`, `Dict[K,V]`, `Union[X,Y]`）を現代構文に統一。
  - 302ファイル、~1,750注釈を機械的に変換
  - 6サブフェーズ（113A-F）で段階的実行：
    - **113A**: common/ パッケージ（10ファイル、86注釈）
    - **113B-1**: core/analysis/ 高トラフィックファイル（5ファイル、~320注釈）
    - **113B-2**: core/analysis/ サブディレクトリ（20ファイル、~235注釈、Set/Dict修正含む）
    - **113C-1**: core/batch/ パッケージ（9ファイル、165注釈、GameNode import修正）
    - **113C-2**: core/reports/ パッケージ（20ファイル、99注釈）
    - **113D-1**: core game core（3ファイル、~210注釈）- **CRITICAL**: ai.py, game.py, game_node.py（150+ファイル依存）
    - **113D-2**: core 残り（6ファイル、147注釈、17ファイルは Phase 114 defer）
    - **113E-1**: gui/features 高トラフィック（3ファイル、121注釈）
    - **113E-2**: gui/features 残り（40ファイル、359注釈、merge conflict解決）
    - **113F-1**: core/analysis tests（3ファイル、50注釈）
    - **113F-2**: batch/report tests（8ファイル、35注釈）
    - **113F-3**: integration/other tests（37ファイル、204注釈）
  - Forward Reference Policy適用:
    - ファイルに `from __future__ import annotations` ある → unquoted unions（`X | None`）に変換
    - ファイルに `from __future__` ない → `Optional["X"]` のまま維持（Phase 114 defer）
  - Safety gates全て PASS:
    - Gate 0: compileall ✅（構文エラーなし）
    - Gate 1: pytest 3776 PASS ✅
    - Gate 2: mypy strict（既知エラーのみ）
    - Gate 3-4: 113D-1は integration tests + 手動スモークテスト完了 ✅
  - PR マージ: #265-276（計12 PR）
  - Phase 114 carryover: 78ファイル（41 Optional[, 19 List[, 13 Dict[, 5 Union[を defer）
  - 主要な修正:
    - PR #268: GameNode import + 二重クォートの type hint 修正
    - PR #267: Set/Dict/Tuple変換の欠落修正（analyzer.py, pacing.py, cluster_classifier.py）
    - PR #273: main ブランチとの merge conflicts 解決（rebase実施）
  - テスト: 3776件パス（前回比変更なし）

- 2026-02-01: Phase 112 完了（mypy strict全体・CIブロック）
  - 全205ファイルの型安全化を達成。1352エラー→0エラー。
  - 7サブフェーズで段階的修正:
    - **112-0**: pyproject.toml strict flags有効化、Python 3.11化
    - **112A**: common/ パッケージ（19件）
    - **112B**: core/ 基盤（sgf_parser.py, game_node.py, game.py、200件）
    - **112C**: core/ AI・エンジン（ai.py, engine.py, ai_strategies_base.py、115件）
    - **112D**: core/ 残り（210件）
    - **112E-1**: gui/widgets/（70件）
    - **112E-2**: gui/features/（128件）
    - **112E-3**: gui/managers/（40件）
    - **112E-4**: gui/ 残り（badukpan.py, popups.py, kivyutils.py, sgf_manager.py等、410件）
    - **112F**: __main__.py + 残りファイル（171件）
    - **112G**: CI typecheck job追加（並列実行）
  - 主要変更:
    - Python 3.11+型構文採用: `X | None`, `dict[str, Any]`, `list[T]`（`Optional`, `Union`, `List`, `Dict` から移行）
    - pyproject.toml: requires-python=">=3.11"、python_version="3.11"、6つのstrict flags（disallow_any_generics, disallow_incomplete_defs, disallow_untyped_defs, check_untyped_defs, strict_equality, extra_checks）
    - CI: typecheck jobを別ジョブ化（testと並列実行）、build jobに依存追加
    - 全関数に型注釈追加（`-> None`, `*args: Any`, `**kwargs: Any`）
    - Kivy互換性: 必要箇所に`type: ignore`コメント追加、Anyを活用
  - 技術仕様:
    - log()メソッドの`level`パラメータを`int`に統一（`str`/`float`から修正）
    - ghost_stone型を`tuple[int, int] | None`に修正（`Any = []`から変更）
    - _config()呼び出しに第2引数（デフォルト値）追加（24箇所）
    - bool()キャスト追加でno-any-returnエラー解消
  - テスト: 3776件パス（変更なし）
  - PR: #258（112-0）、#259（112E-3）、#260（112E-4b）、#261（112E-4c）、#262（112E-4d）、#263（112F）、#264（112G）

- 2026-02-01: Phase 111 完了（gui/features型エラー修正）
  - gui/featuresパッケージの53+件のmypyエラーを解消
  - 変更ファイル（15ファイル）:
    - `katrain/gui/features/auto_mode_popup.py`: `"any"` → `Any`（11箇所）、cast追加
    - `katrain/gui/features/skill_radar_popup.py`: Optional[RadarMetrics]ナローイング
    - `katrain/gui/features/report_navigator.py`: STATUS_* → OUTPUT_*（log引数型修正）
    - `katrain/gui/features/summary_formatter.py`: MistakeCategory Optional注釈、i18n.lang安全フォールバック
    - `katrain/gui/features/summary_stats.py`: Dict型注釈、type: ignore追加
    - `katrain/gui/features/karte_export.py`: List[Tuple[Optional[str], str]]注釈
    - `katrain/gui/features/summary_ui.py`: Optional[str] in Callable signatures
    - `katrain/gui/features/smart_kifu_training_set.py`: katrain_guiオプションパラメータ追加
    - `katrain/gui/features/smart_kifu_practice.py`: Sequence[float]型注釈
    - `katrain/gui/features/quiz_popup.py`, `quiz_session.py`: Optional[Game]ナローイング
    - `katrain/gui/features/settings_popup.py`: type: ignore（プライベート属性アクセス）
    - `katrain/gui/theme.py`: SECONDARY_COLORエイリアス追加
    - `katrain/core/batch/stats/pattern_miner.py`: List → Sequence（covariance）
  - 技術仕様:
    - i18n.current_lang（存在しない）→ i18n.lang安全フォールバックで潜在バグ修正
    - settings_popup.pyの_config/_config_storeアクセスはtype: ignoreで対応（将来的にpublic API移行予定）
    - katrain_guiパラメータはオプション化＋deprecation警告追加（後方互換）
  - gui/featuresでmypyエラー0件達成
  - テスト: 3776件パス
  - goldenファイル更新（潜在バグ修正による出力変更）
  - PR: #252

- 2026-02-01: Phase 110 完了（core パッケージ型エラー修正 第1弾）
  - coreパッケージの9件のmypy型エラーを修正
  - 変更ファイル:
    - `katrain/core/utils.py`: `Dict`インポート追加、`grid`/`PATHS`変数に型注釈追加
    - `katrain/core/curator/scoring.py`: `Enum`インポート追加、`isinstance(key, Enum)`判定、`node`変数に`Optional["GameNode"]`注釈
    - `katrain/core/leela/engine.py`: stdin/stdout非None保証の`assert`追加（3箇所）
  - 技術仕様:
    - `hasattr`から`isinstance(Enum)`への変更で型ナローイング改善
    - subprocess.Popenの`PIPE`モード時はstdin/stdoutが非None保証
    - `grid: List[List[T]]`で型注釈を明示（aliasing問題は将来対応）
  - mypyエラー数: 272 → 263（9件減少）
  - テスト: 3776件パス（変更なし）
  - PR: #251

- 2026-02-01: Phase 109 完了（core/state strict mode + 型エラー修正）
  - core/stateパッケージにmypy strict mode（per-module flags）を適用
  - 6件の型エラーを修正（core/state: 2件、core/analysis: 4件）
  - 変更ファイル:
    - `pyproject.toml`: core/stateにstrict override追加（disallow_any_generics, disallow_untyped_defs等）
    - `katrain/core/state/events.py`: `dict` → `dict[str, Any]`（2箇所）
    - `katrain/core/analysis/presentation.py`: TYPE_CHECKING import追加、_sort_keyヘルパー関数追加
    - `katrain/core/analysis/time/parser.py`: ローカル変数導入で型ナローイング
    - `katrain/core/analysis/engine_compare.py`: 明示的条件式で型ナローイング
  - 技術仕様:
    - `strict = true`は他モジュールに波及するため、per-module flags方式を採用
    - フラグ: disallow_any_generics, disallow_incomplete_defs, disallow_untyped_defs, check_untyped_defs, strict_equality, strict_concatenate
    - core/stateは`mypy --strict`でエラーゼロを達成
  - mypyエラー数: 276 → 272（4件減少）
  - テスト: 3785件パス（変更なし）
  - PR: #250

- 2026-02-01: Phase 108 完了（mypy導入）
  - mypyを開発依存に追加し、CI警告モード（non-blocking）で静的型検査基盤を導入
  - 変更ファイル:
    - `pyproject.toml`: mypy>=1.8.0をdev依存に追加、[tool.mypy]セクション追加
    - `.github/workflows/test_and_build.yaml`: mypy警告モードステップ追加（Python 3.9のみ）
  - 新規ファイル:
    - `katrain/py.typed`: PEP 561マーカーファイル（空ファイル）
  - 技術仕様:
    - python_version = "3.9"（プロジェクト最小サポートバージョン）
    - ignore_missing_imports = true（サードパーティ型スタブ欠落対応）
    - Kivy関連モジュール（kivy.*, kivymd.*, kivy_garden.*）は完全スキップ
    - CIではcontinue-on-error: trueで非blocking実行
  - テスト: 3776件パス（変更なし）
  - PR: #249

- 2026-02-01: Phase 107 完了（KaTrainGui Subscribe）
  - KaTrainGuiにStateNotifier購読ハンドラを追加
  - 変更ファイル:
    - `katrain/__main__.py`: _subscribe_to_events()、_unsubscribe_from_events()、_on_*イベントハンドラ追加
  - 新規ファイル:
    - `tests/test_phase107_gui_subscribe.py`: 18テスト追加
  - 技術仕様:
    - 3イベント購読: GAME_CHANGED, ANALYSIS_COMPLETE, CONFIG_UPDATED
    - coalescing付きUI更新スケジュール（_schedule_ui_update）
    - スレッドセーフロック（_update_lock）
    - 既存のupdate_state()呼び出しは維持（共存）
  - テスト: 3785件パス（+18件）
  - PR: #248

- 2026-02-01: Phase 106A 完了（UI Subscribe MVP）
  - ControlsPanelにANALYSIS_COMPLETE購読機能を追加
  - 変更ファイル:
    - `katrain/gui/controlspanel.py`: EventTypeインポート、on_katrain()、_on_analysis_complete()追加
  - 新規ファイル:
    - `tests/test_phase106_subscribe.py`: 11テスト追加（CI環境ではスキップ）
  - 技術仕様:
    - on_katrain()でsubscribe/unsubscribe管理（katrainプロパティ変更時に自動呼び出し）
    - _on_analysis_complete(): Clock.schedule_once()でメインスレッドにディスパッチ
    - graph.update_value(current_node)呼び出し（冪等性により二重呼び出し安全）
    - 既存のupdate_state()パスと共存（Phase 107で整理予定）
  - テスト: 3767件パス（+11件）
  - PR: #247

- 2026-02-01: Phase 105 完了（Notifier発火ポイント追加）
  - StateNotifierに実際の発火ポイント（notify()呼び出し）を追加
  - 新規ファイル:
    - `katrain/core/notify_helpers.py`: ヘルパー関数2つ（Kivy非依存）
    - `tests/test_phase105_notify.py`: 15テスト追加
  - 変更ファイル:
    - `pyproject.toml`: integrationマーカー登録
    - `katrain/core/base_katrain.py`: CONFIG_UPDATED発火（save_config成功時）
    - `katrain/core/engine.py`: ANALYSIS_COMPLETE発火（解析完了時）
    - `katrain/gui/features/commands/game_commands.py`: GAME_CHANGED発火（新規ゲーム時）
  - 技術仕様:
    - `notify_game_changed(ctx, *, source)`: キーワード専用引数でGAME_CHANGED通知
    - `maybe_notify_analysis_complete(katrain, *, partial_result, results_exist, query_id)`: 条件付きANALYSIS_COMPLETE通知
    - 防御的アクセス: `getattr(ctx, "state_notifier", None)`でnotifier未設定時も安全
    - unbound methodパターン: save_config()テストでロジック複製を回避
  - テスト: 3747件パス（+15件）
  - PR: #246

- 2026-02-01: Phase 104 完了（Notifier統合）
  - StateNotifierをKaTrainBaseに統合し、GUI/ヘッドレスで共通利用可能に
  - 変更ファイル:
    - `katrain/core/state/notifier.py`: ロガー注入対応（LoggerType、_log_error()追加）
    - `katrain/core/base_katrain.py`: StateNotifier初期化、state_notifierプロパティ追加
    - `katrain/gui/features/context.py`: FeatureContext Protocolにstate_notifier追加
    - `tests/test_state_notifier.py`: ロガー注入テスト4件追加
    - `tests/test_typed_config_integration.py`: 統合テスト3件追加
  - 技術仕様:
    - LoggerType = Callable[[str], None]（レベルは呼び出し元でバインド）
    - エラー時は結合メッセージ（msg + traceback）を1回のロガー呼び出しで出力
    - ロガー未設定または失敗時はstderrにフォールバック（例外安全）
    - Kivy非依存を維持（core/state/にログレベル定数の依存なし）
  - テスト: 3732件パス（+7件）
  - PR: #245

- 2026-01-31: Phase 103 完了（StateNotifier基盤）
  - 疎結合な状態変更通知システムの基盤を構築
  - 新規ファイル:
    - `katrain/core/state/__init__.py`: 公開API（EventType, Event, StateNotifier）
    - `katrain/core/state/events.py`: EventType enum（3種）、Event frozen dataclass
    - `katrain/core/state/notifier.py`: StateNotifier実装（subscribe/notify/unsubscribe）
    - `tests/test_state_notifier.py`: 単体テスト（27件）
  - 変更ファイル:
    - `katrain/gui/popups.py`: ConfigPopupのengine直接代入を`update_engine_config()`に移行
  - 技術仕様:
    - Kivy非依存（core層配置）
    - スレッドセーフ（RLock使用）
    - 例外安全（1リスナー失敗が他に影響しない）
    - Event.payload: MappingProxyTypeで浅い不変性を保証
    - スナップショットセマンティクス: notify中のunsubscribeは次回から反映
    - 防御的コピー: 通知中のリスナーリスト変更に安全
  - テスト: 3725件パス（+27件）
  - PR: #244

- 2026-01-31: Phase 102 完了（update_*_config()移行）
  - engine/leela設定の呼び出し元を型付きAPIに移行
  - 変更ファイル:
    - `katrain/__main__.py`: `_save_engine_katago_path()`を`update_engine_config()`に簡略化
    - `katrain/gui/features/settings_popup.py`: engine/leelaセクションを`update_*_config()`に移行
    - `tests/test_typed_config_writer.py`: 4テスト追加
  - 技術詳細:
    - デフォルト値を`LeelaConfig.from_dict({})`から取得（ハードコード禁止）
    - TypedConfigWriterがMERGEセマンティクスを自動処理（未知キー保持）
    - 防御的バリデーション維持（try/exceptでの入力パース）
  - Grep検証: engine/leelaの旧パターンは除外対象の`popups.py`のみ
  - テスト: 3698件パス（+4件）
  - PR: #243

- 2026-01-31: Phase 101 完了（TypedConfigWriter更新API）
  - 型付き設定更新APIを実装し、バリデーションと自動保存の基盤を構築
  - 新規ファイル:
    - `katrain/common/typed_config/writer.py`: TypedConfigWriter, UnknownFieldError, _to_json_safe（~250行）
    - `tests/test_typed_config_writer.py`: TypedConfigWriterテスト（29件）
  - 変更ファイル:
    - `katrain/common/typed_config/__init__.py`: エクスポート追加
    - `katrain/core/base_katrain.py`: update_*_config()メソッド3種追加、TypedConfigWriter初期化
    - `katrain/gui/features/context.py`: FeatureContext Protocol更新（update_*_config追加）
    - `katrain/core/batch/analysis.py`: _DummyEngine.has_query_capacity()追加（CI修正）
    - `katrain/gui/features/quiz_session.py`: Kivyインポート遅延読み込み（CI修正）
    - `katrain/gui/features/quiz_popup.py`: Kivyインポート遅延読み込み（CI修正）
  - 追加API:
    - `TypedConfigWriter`: MERGEパターンで既存値保持＋指定キーのみ更新
    - `UnknownFieldError`: 存在しないフィールド名のエラー
    - `update_engine_config(**kwargs)`: engineセクションの部分更新
    - `update_trainer_config(**kwargs)`: trainerセクションの部分更新
    - `update_leela_config(**kwargs)`: leelaセクションの部分更新
    - `_to_json_safe()`: tuple→list, Path→str等のJSON変換
  - 技術仕様:
    - MERGEパターン: 既存値保持＋指定キーのみ更新＋未知キー保持
    - フィールド検証: dataclass.fields()で有効フィールドを検証
    - JSON-safe永続化: tuple→list, Path→str変換で確実にJSONシリアライズ可能
    - 警告ポリシー: 無効値のデフォルトフォールバック時にWARNINGログ
    - dataclass要件: is_dataclass()でランタイムチェック
  - CI修正:
    - exit code 102問題を解決（Kivyインポートの遅延読み込みパターン導入）
    - _DummyEngineにhas_query_capacity()メソッド追加
  - GitHub設定:
    - mainブランチ保護ルール設定（CI必須化: test 3.9/3.12/3.13）
  - テスト: 3694件パス（+29件）
  - PRs: #242

- 2026-01-30: Phase 91 完了（Beginner Hints - 初心者向けヒント）
  - 初心者の自滅を防ぐヒントシステムを実装
  - 新規ファイル:
    - `katrain/core/beginner/__init__.py`: パッケージ公開API
    - `katrain/core/beginner/models.py`: HintCategory, BeginnerHint, DetectorInput
    - `katrain/core/beginner/detector.py`: 4検出関数 + find_matching_group
    - `katrain/core/beginner/hints.py`: compute_beginner_hint, get_beginner_hint_cached
    - `tests/test_beginner_hints.py`: 16テスト
  - 変更ファイル:
    - `katrain/config.json`: beginner_hints セクション追加
    - `katrain/gui/controlspanel.py`: ヒント表示追加
    - `katrain/gui/features/settings_popup.py`: ON/OFFトグル追加
    - `katrain/i18n/locales/en/LC_MESSAGES/katrain.po`: 10翻訳キー追加
    - `katrain/i18n/locales/jp/LC_MESSAGES/katrain.po`: 10翻訳キー追加
  - 4カテゴリ検出:
    - SELF_ATARI: 自アタリ検出（1石除外、取り返し考慮）
    - IGNORE_ATARI: アタリ放置検出（サイズ3以上）
    - MISSED_CAPTURE: 取り逃し検出（サイズ2以上）
    - CUT_RISK: 切断リスク検出（改善閾値15.0、総サイズ6以上）
  - 技術仕様:
    - モードゲーティング: PLAYモードでは無効（チート防止）
    - ノードキャッシュ: センチネル値で未計算とNoneを区別
    - ノード状態管理: try-finallyで確実に復元
    - ランタイムガード: assert不使用（-O対応）
  - テスト: 3332件パス（+16件）
  - PRs: #232

- 2026-01-30: Phase 90 完了（Error Recovery & Diagnostics - エラー救済/診断）
  - エラー発生時の復旧導線とLLM相談支援機能を実装
  - 新規ファイル:
    - `katrain/core/error_recovery.py`: スレッドセーフ重複排除、4096バイトUTF-8制限（~93行）
    - `katrain/gui/features/recovery_actions.py`: 4つの復旧アクション関数（~233行）
    - `tests/test_error_recovery.py`: エラー復旧テスト（19件）
  - 変更ファイル:
    - `katrain/core/diagnostics.py`: collect_diagnostics_bundle()、format_llm_diagnostics_text()パブリックAPI追加、extra_filesパラメータ追加
    - `katrain/core/base_katrain.py`: get_config_snapshot()メソッド追加
    - `katrain/core/auto_setup.py`: prepare_reset_to_auto()関数追加
    - `katrain/gui/features/context.py`: FeatureContext Protocol拡張
    - `katrain/gui/popups.py`: EngineRecoveryPopupに4つのアクションメソッド追加
    - `katrain/popups.kv`: 復旧ボタン4つ追加
    - `katrain/i18n/locales/en/LC_MESSAGES/katrain.po`: 8翻訳キー追加
    - `katrain/i18n/locales/jp/LC_MESSAGES/katrain.po`: 8翻訳キー追加
  - 追加API:
    - `DiagnosticsTrigger` Enum - ENGINE_START_FAILED, TEST_ANALYSIS_FAILED, CONSECUTIVE_FAILURE, MANUAL
    - `RecoveryEvent` frozen dataclass - trigger, error_message, event_id（SHA256ベース）
    - `should_auto_dump()` - スレッドセーフ重複排除（threading.Lock）
    - `truncate_to_bytes()` - UTF-8バイト境界で安全に切り詰め（4096バイト制限）
    - `collect_diagnostics_bundle()` - DiagnosticsBundle収集のパブリックAPI
    - `format_llm_diagnostics_text()` - LLM用サニタイズ済みテキスト生成
    - `prepare_reset_to_auto()` - 自動モード復帰用設定準備
    - `get_config_snapshot()` - 設定スナップショット取得（プライベート属性回避）
  - UI機能:
    - 「自動モードに戻す（推奨）」ボタン - ワンクリック復帰
    - 「LLM相談用にコピー」ボタン - サニタイズ済み診断テキストをクリップボードへ
    - 「診断ZIPを保存」ボタン - llm_prompt.txt含むZIP生成
    - 「ログをコピー」ボタン - 末尾200行をサニタイズしてコピー
  - 技術仕様:
    - Python 3.9互換: Optional/Dict/List構文使用（PEP604不可）
    - スレッド安全: メインスレッドでデータ収集、バックグラウンドはZIP作成のみ
    - 重複排除: SHA256ベースevent_id + threading.Lockで二重ダンプ防止
    - バイト制限: UTF-8バイト単位で4096バイト以下を強制
  - テスト: 3316件パス（+19件）
  - PRs: #231

- 2026-01-30: Phase 89 完了（Auto Setup Mode - "まず動かす"自動モード）
  - 初回起動で解析が成功する確率を最大化する自動セットアップモードを実装
  - 新規ファイル:
    - `katrain/core/auto_setup.py`: 自動セットアップコアロジック（~352行）
    - `katrain/core/test_analysis.py`: エラー分類・テスト解析結果（~188行）
    - `katrain/gui/features/auto_mode_popup.py`: 自動セットアップUI（~743行）
    - `tests/test_auto_setup.py`: 自動セットアップテスト（23件）
    - `tests/test_test_analysis.py`: エラー分類テスト（43件）
  - 変更ファイル:
    - `katrain/__main__.py`: engine_unhealthy属性、restart_engine_with_fallback()、restart_engine()、save_auto_setup_result()追加
    - `katrain/core/engine.py`: get_backend_type()、create_minimal_analysis_query()追加
    - `katrain/gui/features/settings_popup.py`: Auto Setupタブ（tab4）追加
    - `katrain/i18n/locales/en/LC_MESSAGES/katrain.po`: 24翻訳キー追加
    - `katrain/i18n/locales/jp/LC_MESSAGES/katrain.po`: 24翻訳キー追加
  - 追加API:
    - `ErrorCategory` Enum - ENGINE_START_FAILED, MODEL_LOAD_FAILED, BACKEND_ERROR, TIMEOUT, LIGHTWEIGHT_MISSING, UNKNOWN
    - `TestAnalysisResult` frozen dataclass - success, error_category, error_message
    - `classify_engine_error()` - 2段階パターンマッチング（強/弱シグナル）
    - `get_auto_setup_config()` - 新規/既存ユーザー判定とモード決定
    - `should_show_auto_tab_first()` - Autoタブ優先表示判定
    - `find_lightweight_model()` - b10c128軽量モデル検索
    - `find_cpu_katago()` - CPU版KataGo（Eigen）検索
    - `resolve_auto_engine_settings()` - 自動モード用エンジン設定構築
  - 技術仕様:
    - 新規ユーザー検出: USER_CONFIG_FILE存在チェック
    - エラー分類: 2段階パターンマッチング（OpenCL/CUDA/モデル/エンジン起動）
    - CPUフォールバック: OpenCL失敗時にEigen版へ自動切替、検証付き永続化
    - スレッド安全: AutoModeStateクラス（per-popup状態管理）、Clock.schedule_once()
    - パス解決: DATA_FOLDER定数使用（ハードコードなし）
  - テスト: 3297件パス（+66件）
  - PRs: #230

- 2026-01-30: Phase 88 完了（KataGo Settings UI Reorganization + human-like Exclusivity）
  - KataGo設定UIの再構成とhuman-like排他制御を実装
  - 新規ファイル:
    - `katrain/common/model_labels.py`: モデル強度分類（~60行）
    - `katrain/common/humanlike_config.py`: 正規化ロジック（~40行）
    - `tests/test_model_labels.py`: カテゴリ判定テスト（20件）
    - `tests/test_humanlike_config.py`: 正規化ロジックテスト（9件）
  - 変更ファイル:
    - `katrain/config.json`: `humanlike_model_last`キー追加
    - `katrain/gui/popups.py`: humanlike_enabled, on_humanlike_enabled, _handle_humanlike_toggle, get_model_display_text追加
    - `katrain/popups.kv`: Switchトグル+ステータス表示、モデル強度ラベル追加
    - `katrain/i18n/locales/en/LC_MESSAGES/katrain.po`: 18翻訳キー追加
    - `katrain/i18n/locales/jp/LC_MESSAGES/katrain.po`: 18翻訳キー追加
  - 追加API:
    - `classify_model_strength()` - ファイル名からLight/Standard/Strong/Unknown分類
    - `get_model_i18n_key()` - i18nキー返却（"model:light"等）
    - `get_model_basename()` - クロスプラットフォームbasename取得
    - `normalize_humanlike_config()` - Option A正規化（パス空時は強制OFF）
  - 技術仕様:
    - クロスプラットフォーム: `_cross_platform_basename()`でLinux CIでもWindowsパス対応
    - Option A排他制御: トグルON+パス空→強制OFF、パス退避→`humanlike_model_last`
    - UIバインディング: Kivy `on_<property>` 自動コールバック使用
    - モデルラベルはi18nキーのみ返却（文字列結合なし）
  - テスト: 3231件パス（+29件）
  - PRs: #228, #229

- 2026-01-30: Phase 87.6 完了（Leela Batch Output Fix）
  - Leela Zeroバッチ解析で解析済みSGF・カルテ・サマリーが生成されない問題を修正
  - 変更ファイル:
    - `katrain/core/batch/analysis.py`: `_DummyEngine`追加、0手SGFをfail_result()に変更、解析品質ログ追加
    - `katrain/core/batch/orchestration.py`: Success gate強化、karte_failed追跡追加、古いログメッセージ削除
    - `katrain/core/batch/stats/extraction.py`: 空snapshot時のログ追加
    - `tests/test_batch_leela_analysis.py`: Phase 87.6テスト追加（4件）
  - 追加API:
    - `_DummyEngine` クラス - engine=None時のクラッシュ防止（no-op stop_pondering()）
  - 技術仕様:
    - Success gate: game is not None だけでなく snapshot.moves も検証
    - 0手SGF: fail_result()を返却（以前はsuccess_result()で空snapshotを返していた）
    - karte_failed: 解析失敗時にインクリメント（karte_total = karte_written + karte_failed）
    - parse_errorカウント: getattr()でNone/missing属性に対するガード
  - テスト: 3202件パス（+3件）
  - PRs: #227

- 2026-01-30: Phase 87.5 完了（Batch Analysis UI & Settings UI Consistency）
  - Batch UIとSettings UIの一貫性・安全性改善
  - 変更ファイル:
    - `katrain/__main__.py`: Leela gating呼び出し
    - `katrain/core/batch/orchestration.py`: leela_snapshot渡し、karte有効化
    - `katrain/core/batch/stats/extraction.py`: snapshotパラメータ追加
    - `katrain/core/reports/karte/builder.py`: snapshotパラメータ追加
    - `katrain/gui/features/batch_core.py`: is_leela_configured()、3ステップLeela起動
    - `katrain/gui/features/batch_ui.py`: Variable visits連動、Leelaゲーティング
    - `katrain/gui/features/settings_popup.py`: initial_tab対応、Leelaゲーティング
  - 追加API:
    - `is_leela_configured()` - Leela設定状態検出ヘルパー
    - `extract_game_stats(snapshot=)` - 事前構築snapshot対応
    - `build_karte_report(snapshot=)` - 事前構築snapshot対応
  - 技術仕様:
    - 3ステップLeela起動: 既存確認→起動試行→最終検証
    - 失敗時STATUS_ERRORでステータスバー通知
    - Variable visits OFF時にJitter%/Deterministic無効化
    - Leela未設定時は両UIでLeelaオプション無効化
  - テスト: 3199件パス（+7件）
  - PRs: #226

- 2026-01-30: Phase 86 完了（Reason Generator 限定実装）
  - ミスパターンから自然言語の「理由文」を生成する限定実装
  - 新規ファイル:
    - `katrain/core/analysis/reason_generator.py`: 理由生成ロジック（~320行）
    - `tests/test_reason_generator.py`: ユニットテスト（20件）
  - 変更ファイル:
    - `katrain/core/analysis/__init__.py`: エクスポート追加
    - `katrain/core/reports/karte/sections/important_moves.py`: Critical 3にReason行追加
    - `katrain/gui/features/summary_formatter.py`: Recurring PatternsにReason行追加
  - 追加API:
    - `ReasonTemplate` frozen dataclass - 日英テンプレート
    - `SUPPORTED_TAGS` frozenset - 対象タグ（12件）
    - `PHASE_VOCABULARY`, `AREA_VOCABULARY` frozenset - 有効値セット
    - `SINGLE_TAG_REASONS` dict - 単発タグテンプレート（12件、JP+EN）
    - `COMBINATION_REASONS` dict - 組み合わせテンプレート（8件、JP+EN、ワイルドカード対応）
    - `generate_reason()` - 理由文生成（None返却可）
    - `generate_reason_safe()` - 安全版（例外を投げない）
  - 技術仕様:
    - ワイルドカード `"*"` でスロット非検査（例: `(phase, "*", tag)` は任意のareaにマッチ）
    - 言語正規化: `lang=None`→日本語、`lang=""`→英語、未知→英語フォールバック
    - `normalize_lang_code()` 委譲（内部コード "jp"/"en"）
    - area=None でも `(phase, "*", tag)` ワイルドカードにマッチ
  - テスト: 3180件パス（+20件）
  - PRs: #224

- 2026-01-30: Phase 85 完了（Pattern to Summary Integration）
  - Phase 84の`mine_patterns()`をSummaryレポートに統合
  - 変更ファイル:
    - `katrain/core/batch/stats/extraction.py`: `pattern_data`フィールドと`source_index`パラメータ追加
    - `katrain/core/batch/orchestration.py`: `source_index`渡し追加
    - `katrain/gui/features/summary_formatter.py`: パターンマイニング統合（+435行）
    - `katrain/i18n/locales/en/LC_MESSAGES/katrain.po`: 11翻訳キー追加
    - `katrain/i18n/locales/jp/LC_MESSAGES/katrain.po`: 11翻訳キー追加
  - 新規テストファイル:
    - `tests/test_pattern_summary_contract.py`: 契約テスト（22件）
  - 追加API:
    - `_PatternMoveEval` クラス - duck-typed MoveEval for pattern mining
    - `_FakeSnapshot` クラス - duck-typed EvalSnapshot
    - `_normalize_board_size()` - board_size正規化（tuple/list両対応）
    - `_filter_by_board_size()` - 正方形board_sizeでフィルタ
    - `_stable_sort_key()` - 決定論的ソートキー（source_index tie-breaker）
    - `_is_valid_player()`, `_is_valid_gtp()`, `_is_valid_move_number()` - 入力検証
    - `_reconstruct_pattern_input()` - stats_listからパターンマイニング入力を再構築
    - `_mine_patterns_safe()` - 遅延importラッパー
    - `_format_game_refs()` - ゲーム参照のフォーマット
    - `_append_recurring_patterns()` - Recurring Patternsセクション追加
  - 技術仕様:
    - TYPE_CHECKINGガードで循環import防止
    - GTP座標検証（正規表現+board_size範囲チェック）
    - 決定論的ソート（game_name, date, total_moves, source_index）
    - invalid dataでクラッシュしない本番安全性
    - unknown phase/area/severity時にdebugログ出力
  - テスト: 3160件パス（+22件）
  - PRs: #223

- 2026-01-30: Phase 84 完了（Recurring Pattern Mining Core）
  - 複数SGFを横断して繰り返しミスを検出する基盤
  - 新規ファイル:
    - `katrain/core/batch/stats/pattern_miner.py`: パターン抽出ロジック（~280行）
    - `tests/test_pattern_miner.py`: ユニットテスト（56件）
  - 変更ファイル:
    - `katrain/core/batch/stats/__init__.py`: エクスポート追加
  - 追加API:
    - `MistakeSignature` frozen dataclass - ミスのパターン署名（phase/area/primary_tag/severity）
    - `GameRef` frozen dataclass - ゲーム内参照（game_name/move_number/player）
    - `PatternCluster` dataclass - パターンの集約（count/total_loss/game_refs/impact_score）
    - `create_signature()` - MoveEvalから署名を生成
    - `mine_patterns()` - 複数ゲームから頻出パターンを抽出
    - `get_severity()` - MistakeCategory → severity文字列
    - `determine_phase()` - 手番号からフェーズを判定（盤サイズ対応）
    - `get_area_from_gtp()` - GTP座標からエリアを判定（Iスキップ対応）
  - 定数:
    - `LOSS_THRESHOLD = 2.5` - ミス判定閾値
    - `OPENING_THRESHOLDS` - 盤サイズ別序盤閾値（9:15, 13:25, 19:40）
    - `AREA_THRESHOLDS` - 盤サイズ別エリア閾値（9:3, 13:4, 19:4）
    - `MAX_GAME_REFS_PER_CLUSTER = 10` - クラスタ当たり参照上限
  - 技術仕様:
    - GTP座標のIスキップ対応（K=9, J=8）
    - 入力正規化（小文字、空白除去）
    - 決定論的ソート（-impact_score, signature.sort_key()）
    - FakeMoveEval（SimpleNamespace）でテスト分離
  - テスト: 3144件パス（+56件）
  - PRs: #222

- 2026-01-30: Phase 83 完了（Complexity Filter）
  - 高変動局面（scoreStdev > 20）のミスをCritical 3選定で70%割引
  - 変更ファイル:
    - `katrain/core/analysis/critical_moves.py`: 複雑度フィルタ追加（+132行）
    - `katrain/core/analysis/__init__.py`: re-export追加
    - `katrain/core/reports/karte/sections/important_moves.py`: 複雑度注記追加
  - 新規テストファイル:
    - `tests/test_complexity_filter.py`: ユニットテスト（12件）
  - 追加API:
    - `THRESHOLD_SCORE_STDEV_CHAOS` (20.0) - Chaos判定閾値
    - `COMPLEXITY_DISCOUNT_FACTOR` (0.3) - 割引率
    - `ComplexityFilterStats` dataclass - フィルタ統計
    - `_compute_complexity_discount()` - 割引計算（None=1.0, >20=0.3）
    - `CriticalMove.complexity_discounted` - 割引されたかどうかのフラグ
  - 設計ポイント:
    - 除外ではなく割引（大きなミスは残る）
    - stdev_cacheで二重計算回避
    - ctx.lang分岐でi18n不要
    - INFO/DEBUGログで可視化
  - テスト: 3088件パス（+21件）
  - PRs: #221

- 2026-01-30: Phase 82 完了（Consequence判定 + Karteへ限定統合）
  - Phase 81のOwnershipクラスタを3分類（GROUP_DEATH / TERRITORY_LOSS / MISSED_KILL）へ分類
  - 新規ファイル:
    - `katrain/core/analysis/cluster_classifier.py`: クラスタ分類ロジック（~600行）
    - `tests/test_cluster_classifier.py`: ユニットテスト（57件）
    - `tests/test_karte_cluster_context.py`: 統合テスト（16件）
  - 追加API:
    - `ClusterSemantics` enum（GROUP_DEATH/TERRITORY_LOSS/MISSED_KILL/AMBIGUOUS）
    - `ClassifiedCluster` dataclass - 分類結果
    - `StoneCache` class - 石位置のキャッシュ
    - `compute_stones_at_node()` - 純粋関数での石再構築（UI副作用なし）
    - `classify_cluster()` - クラスタを3分類に判定
    - `_get_cluster_context_for_move()` - Karte統合用エントリポイント
    - `get_semantics_label()` - ローカライズラベル取得（en/jp）
  - Karte統合:
    - `important_moves.py`: Critical 3で`reason_tags`が空の場合のみクラスタ分類を注入
  - 技術仕様:
    - 石再構築: nodes_from_rootから再構築（current_node変更なし、スレッドセーフ）
    - SGF処理: placements(AB/AW)は取りなし、moves(B/W)は取りあり、AEで除去
    - 自殺手: 自グループを除去（安全に処理）
    - mainline: ordered_children[0]で辿る
    - 信頼度閾値: semantics別（GROUP_DEATH=0.3, MISSED_KILL=0.4, TERRITORY_LOSS=0.5）
  - テスト: 3067件パス（+79件）
  - PRs: #220

- 2026-01-30: Phase 81 完了（Ownershipクラスタ抽出MVP）
  - ownership差分から変動の塊（クラスタ）を抽出するMVP
  - 新規ファイル:
    - `katrain/core/analysis/ownership_cluster.py`: クラスタ抽出ロジック
    - `tests/test_ownership_cluster.py`: ユニットテスト
  - 追加API:
    - `OwnershipDelta` dataclass - ownership差分
    - `OwnershipCluster` dataclass - 抽出されたクラスタ
    - `ClusterType` enum（TO_BLACK/TO_WHITE）
    - `ClusterExtractionConfig` dataclass - 抽出設定
    - `ClusterExtractionResult` dataclass - 抽出結果
    - `compute_ownership_delta()` - 差分計算
    - `extract_clusters()` - BFSでクラスタ抽出
    - `extract_clusters_from_nodes()` - GameNode→クラスタ抽出
  - 技術仕様:
    - BFS: deque使用でO(1)
    - 閾値: min_delta=0.2, min_cluster_size=2
    - sum_delta符号: >0で黒有利化、<0で白有利化
  - テスト: 2988件パス（+27件）
  - PRs: #219

- 2026-01-30: Phase 80 完了（共通基盤 - Area判定・抽出ヘルパ）
  - Phase 81-87（Analysis Intelligence）の土台となる共通基盤を整備
  - 新規ファイル:
    - `katrain/core/analysis/board_context.py`: Area判定、ownership/scoreStdev抽出
  - 追加API:
    - `BoardArea` enum（CORNER/EDGE/CENTER）
    - `classify_area()` - 座標→BoardArea判定
    - `get_area_name()` - 区域名取得（jp/en対応）
    - `OwnershipContext` dataclass - ownership_grid + scoreStdev + board_size
    - `extract_ownership_context()` - GameNode→OwnershipContext抽出
    - `get_score_stdev()` - scoreStdevヘルパ
  - 技術仕様:
    - 言語コード: デフォルト "jp"、"ja"は"jp"として扱う
    - 座標: (col, row) = (x, y)、None/範囲外→None返却
    - ownership_grid: grid[row][col]、row 0=下辺(y=0)
    - board_size正規化: tuple→そのまま、int→(n,n)、その他→(19,19)
  - テスト: 2961件パス（+37件）
  - PRs: #218

- 2026-01-28: Phase 79 完了（エラーハンドリング C - バックグラウンドパス）
  - Phase 77監査結果に基づき、バックグラウンド処理の27箇所を改善
  - 12ファイル更新:
    - `katrain/core/batch/analysis.py`: analyze_single_file, analyze_single_file_leela (SGFError, OSError, UnicodeDecodeError)
    - `katrain/core/batch/orchestration.py`: Karte generation, stats extraction, summary, curator (KarteGenerationError, MixedEngineSnapshotError, OSError, KeyError, ValueError)
    - `katrain/core/curator/batch.py`: Ranking JSON, guide extraction, guide JSON (OSError, KeyError, ValueError)
    - `katrain/core/reports/karte/builder.py`: Style computation, karte report, time analysis, histogram (ValueError, KeyError)
    - `katrain/core/reports/karte/json_export.py`: Phase classification (ValueError)
    - `katrain/core/reports/karte/sections/important_moves.py`: Context extraction, Critical 3 (KeyError)
    - `katrain/core/reports/karte/sections/metadata.py`: Risk section (KeyError, ValueError)
    - `katrain/core/reports/package_export.py`: Directory check, coach.md loading, ZIP creation (OSError, TypeError, zipfile.BadZipFile)
    - `katrain/gui/features/summary_aggregator.py`: SGF scan (SGFError, OSError)
    - `katrain/gui/features/summary_io.py`: Player/category save, clipboard, file export (OSError, RuntimeError)
    - `katrain/gui/features/summary_ui.py`: SGF processing loop (SGFError, OSError, KeyError)
    - `tests/test_karte_style_integration.py`: Expected/Unexpected exception split対応
  - 設計原則:
    - Expected exceptions（既知の失敗）: 短いログ、tracebackなし
    - Unexpected exceptions（内部バグ）: traceback必須（exc_info=True or traceback.format_exc()）
    - WriteError message prefix pattern: `[generation]`, `[write]`, `[unexpected]`
  - 新規テスト:
    - `test_error_handling_phase79.py`（5テスト）: analyze_single_file, _is_writable_directory, create_llm_package
  - テスト: 2924件パス（+6件）
  - PRs: #217

- 2026-01-28: Phase 78 完了（エラーハンドリング B - ユーザー操作パス）
  - Phase 77監査結果に基づき、ユーザー操作に直結する20箇所を改善
  - 8ファイル更新:
    - `katrain/core/sgf_parser.py`: GIB komi/date抽出 (AttributeError, ValueError)
    - `katrain/gui/features/settings_popup.py`: Export/Import/Save (OSError, UnicodeDecodeError, JSONDecodeError)
    - `katrain/gui/sgf_manager.py`: クリップボード/ファイル操作 (ParseError, OSError)
    - `katrain/gui/features/engine_compare_popup.py`: 比較ビルド (ValueError, AttributeError)
    - `katrain/gui/features/package_export_ui.py`: カルテ/SGF生成 (KarteGenerationError, MixedEngineSnapshotError)
    - `katrain/gui/popups.py`: Spinner fallback (ValueError), InputParseError with traceback
    - `katrain/common/settings_export.py`: Atomic save cleanup with logging
    - `katrain/tools/batch_analyze_sgf.py`: エンジン起動 (OSError, RuntimeError, EngineError)
  - 設計原則:
    - Safe Boundary Pattern（既知例外→境界フォールバック）
    - サイレントな例外無視を排除（全ハンドラでログ出力）
    - `from e`によるtraceback保持
    - 例外ハンドラ内での安全なプレビュー構築（プライバシー保護）
  - テスト: 2918件パス（変更なし）
  - PRs: #216

- 2026-01-28: Phase 77 完了（エラーハンドリング A - 監査・分類）
  - 全 `except Exception` ハンドラを AST 解析で監査
  - 新規スクリプト:
    - `scripts/audit_exceptions.py`: AST ベースの検出（173ファイルスキャン、108件検出）
    - `scripts/generate_audit_stub.py`: Markdown テーブルスタブ生成
    - `scripts/generate_audit_doc.py`: 完全監査ドキュメント生成（自動分類付き）
    - `scripts/verify_audit.py`: 監査ドキュメント検証（enum/TODO/? チェック）
  - 新規ドキュメント:
    - `docs/archive/error-handling-audit.md`: 全108件の分類結果
  - 分類結果:
    - intentional（意図的）: 39件
    - improve（改善対象）: 69件
    - noqa コメント付き: 18件
  - カテゴリ分布:
    - file-io-fallback: 32件
    - ui-state-restore: 22件
    - thread-exception: 18件
    - partial-failure: 14件
    - external-lib: 10件
    - shutdown-cleanup: 4件
    - callback-protection: 4件
    - traceback-format: 4件
  - DoD 全条件パス:
    - スキップファイル: 0件
    - 件数一致: JSON 108 == Doc 108
    - TODO/? 残存: 0件
    - enum 違反: 0件
    - 既存テスト: 2918件パス
  - PRs: #215

- 2026-01-28: Phase 76 完了（KaTrainGui分割D - GameStateManager）
  - KaTrainGuiからゲーム状態のライフサイクル管理をGameStateManagerに抽出
  - 新規: `katrain/gui/managers/game_state_manager.py`（~130行）
    - GameStateManagerクラス: undo/redo、重要局面ナビゲーション、投了、ノート設定、挿入モード
    - 依存注入パターン（Kivy非依存テスト実現）
  - 設計特徴:
    - PEP 562 lazy imports（`__init__.py`でKivy依存を遅延読み込み）
    - `set_note`にガード追加（早期UI呼び出し対策）
    - "smart" undoはKaTrainGuiに残存（player_info依存）
  - テスト: 22件追加（`tests/test_game_state_manager.py`）
  - テスト総数: 2918件

- 2026-01-28: Phase 75 完了（KaTrainGui分割C - PopupManager）
  - KaTrainGuiから設定系ポップアップ管理責務をPopupManagerに抽出
  - 新規: `katrain/gui/managers/popup_manager.py`（~154行）
    - PopupManagerクラス: ポップアップのキャッシュと開閉制御
    - 依存注入パターン（ファクトリ関数、状態アクセサ、コールバック）
  - 設計特徴:
    - Kivy完全非依存（typing のみ使用）
    - キャッシュポリシー:
      - new_game, timer, teacher, ai: キャッシュ再利用（初回のみファクトリ呼び出し）
      - engine_recovery: 毎回新規作成（キャッシュなし）
    - タイマー一時停止ポリシー:
      - new_game, timer, teacher, ai: pause_timer()を呼ぶ
      - engine_recovery: pause_timer()を呼ばない（エラー条件によるトリガーのため）
    - getattr fallbackパターン（`__self__`属性の堅牢性）
    - Null-safe `_safe_pause_timer`（getattr chain使用）
  - KaTrainGui統合:
    - 5メソッドをPopupManagerに委譲（`_do_new_game_popup`等）
    - 4つの状態変数削除（`new_game_popup`, `ai_settings_popup`, `teacher_settings_popup`, `timer_settings_popup`）
    - 5つのファクトリメソッド追加（`_create_*_popup`）
  - 新規テスト:
    - `tests/test_popup_manager.py`（21テスト）: ユニットテスト（Kivy非依存）
  - テスト総数: 2896件（+21件）
  - PRs: #213
- 2026-01-27: Phase 74 完了（KaTrainGui分割B - ConfigManager）
  - KaTrainGuiから設定管理責務をConfigManagerに抽出
  - 新規: `katrain/gui/managers/config_manager.py`（~196行）
    - ConfigManagerクラス: 設定の読み取り・書き込み・セクション管理
    - 依存注入パターン（config_dict, save_config, logger, log_level_info）
  - 設計特徴:
    - Kivy完全非依存（typing のみ使用）
    - 更新セマンティクス明確化:
      - `set_section()`: REPLACE（セクション全体を置き換え）
      - `save_export_settings()`: PARTIAL UPDATE（None は「変更しない」）
      - `save_batch_options()`: PARTIAL UPDATE（batch_options サブツリーのみ MERGE）
    - コピーセマンティクス:
      - `get()`: 直接参照を返す（パフォーマンス優先、呼び出し元は変更禁止）
      - `get_section()`: SHALLOW COPY を返す（トップレベルキーのみ保護）
    - 非dict値への安全な対応（空辞書またはdefaultを返す）
    - 破損データ対応（batch_optionsが非dictの場合、ログ出力して{}にリセット）
  - KaTrainGui統合: 4メソッドをConfigManagerに委譲
    - `set_config_section()` → `_config_manager.set_section()`
    - `_load_export_settings()` → `_config_manager.load_export_settings()`
    - `_save_export_settings()` → `_config_manager.save_export_settings()`
    - `_save_batch_options()` → `_config_manager.save_batch_options()`
  - 新規テスト:
    - `tests/test_config_manager.py`（36テスト）: ユニットテスト（Kivy非依存）
    - `tests/test_config_imports.py`（13テスト）: 後方互換API・シグネチャ検証
  - テスト総数: 2875件（+49件）
  - PRs: #212
- 2026-01-27: Phase 73 完了（KaTrainGui分割A - KeyboardManager）
  - KaTrainGuiからキーボード処理（約145行）をKeyboardManagerに抽出
  - 新規: `katrain/gui/managers/` パッケージ
    - `__init__.py`（7行）: 空パッケージ（docstringのみ）
    - `keyboard_manager.py`（~280行）: KeyboardManagerクラス
  - 設計特徴:
    - 依存注入パターン（SGFManagerと同様）
    - Kivy依存（platform, Clock, Clipboard）をコンストラクタで注入
    - Kivy非依存のユニットテストが可能
    - `KaTrainGui.shortcuts`は委譲プロパティとして後方互換維持
  - 新規: `tests/test_keyboard_manager.py`（53テスト）
    - ナビゲーション、ポップアップ、修飾キー、単独キー等をカバー
  - テスト総数: 2826件（+53件）
  - PRs: #211
- 2026-01-27: Phase 72 完了（karte_report.py 分割）
  - `katrain/core/reports/karte_report.py`（1,610行、1,009行関数含む）を12モジュールのパッケージに分割
  - 新規: `katrain/core/reports/karte/` パッケージ
    - `models.py`（~80行）: 例外クラス、定数（最下層）
    - `helpers.py`（~80行）: 純粋関数（`has_loss_data`, `format_loss_with_engine_suffix`等）
    - `builder.py`（~580行）: メインエントリポイント（`build_karte_report`）
    - `json_export.py`（~230行）: JSON出力（`build_karte_json`）
    - `llm_prompt.py`（~60行）: LLMプロンプト生成（`build_critical_3_prompt`）
    - `sections/context.py`（~60行）: `KarteContext` dataclass（閉包変数の明示化）
    - `sections/summary.py`（~210行）: サマリ・分布セクション
    - `sections/important_moves.py`（~310行）: 重要手・タグセクション
    - `sections/diagnosis.py`（~330行）: 弱点・練習優先度セクション
    - `sections/metadata.py`（~220行）: 定義・品質・リスクセクション
  - シム化: `karte_report.py`（~45行）- 後方互換シム
  - 新規: `tests/test_karte_imports.py`（13テスト）- 後方互換性・lazy importテスト
  - 設計特徴:
    - `KarteContext` dataclass で閉包変数を明示化
    - `karte/__init__.py` でlazy wrapper使用（循環インポート回避）
    - 依存階層: models → helpers/context → sections → builder
  - テスト総数: 2773件（+13件）
  - PRs: #210
- 2026-01-27: Phase 71 完了（batch/stats.py 分割）
  - `katrain/core/batch/stats.py`（1,799行）を4モジュールのサブパッケージに分割
  - 新規: `katrain/core/batch/stats/` パッケージ
    - `models.py`（~240行）: `EvidenceMove` dataclass、i18n定数
    - `extraction.py`（~340行）: `extract_game_stats()`, `extract_players_from_stats()`
    - `aggregation.py`（~560行）: `build_batch_summary()`, i18n getter、ヘルパー関数
    - `formatting.py`（~770行）: `build_player_summary()`（遅延ロード）
    - `__init__.py`（~170行）: 再エクスポート、遅延ロード、後方互換エイリアス
  - 削除: `katrain/core/batch/stats.py`（元の1,799行ファイル）
  - 新規: `tests/test_batch_stats_imports.py`（17テスト）- 後方互換性テスト
  - 後方互換性: 全APIが`from katrain.core.batch.stats import ...`で引き続き利用可能
  - テスト総数: 2760件（+11件）
  - PRs: #209
- 2026-01-27: Phase 70 完了（Complex Function Refactoring）
  - `analyze_extra()` 分割:
    - 新規: `_process_move_analysis()` - 単一手の解析処理
    - 新規: `_apply_analysis_results()` - 解析結果の適用
  - `_compute_important_moves()` 最適化:
    - 新規: `_aggregate_importance_scores()` - 重要度スコア集計
    - 新規: `_filter_and_sort_important()` - フィルタリングとソート
  - テスト総数: 2749件
  - PRs: #208
- 2026-01-27: Phase 69 完了（Parser/Base Test Enhancement）
  - `tests/test_parser.py` 拡張: 19テスト追加
    - TestMoveClass (9): ラウンドトリップ、I列拒否、等価性・ハッシュ
    - TestParseError (3): 不正SGF検出
    - TestPropertyEdgeCases (5): KM/HA無効値、標準ボードサイズ
    - TestRoundTrip (2): 特殊文字、変化ツリーのセマンティック等価性
  - `tests/test_base_katrain.py` 新規作成: 17テスト
    - TestParseVersion (4): バージョン文字列パース
    - TestPlayerClass (7): プロパティ・メソッド
    - TestKaTrainBaseConfig (4): 設定取得（分離環境）
    - TestKaTrainBaseLogging (2): ログバッファ記録
  - テスト総数: 2758件（+36件）
  - PRs: #207
- 2026-01-26: Phase 68 完了（Command Pattern for KataGoEngine）
  - Phase 68-A: Command Core
    - 新規: `katrain/core/engine_query.py`（~140行）
      - `build_analysis_query()`: KataGoクエリ構築の純粋関数
      - `_build_avoid_list()`: 回避リスト構築ヘルパー
    - 新規: `katrain/core/engine_cmd/` パッケージ
      - `commands.py`（~220行）: `AnalysisCommand` ABC, `StandardAnalysisCommand`
      - `executor.py`（~400行）: `CommandExecutor`（ライフサイクル管理）
    - 新規: `tests/test_engine_query.py`（14テスト）
    - 新規: `tests/test_engine_commands.py`（43テスト）
  - Phase 68-B: Engine統合
    - 変更: `engine.py` が `build_analysis_query()` をインポートして使用
    - 削減: ~33行（クエリ構築ロジック移動）
  - Phase 68-C: Pondering便利メソッド
    - 新規: `executor.is_pondering` プロパティ
    - 新規: `executor.get_ponder_command()` メソッド
    - 新規: `executor.stop_pondering()` メソッド
    - 追加: 13テスト（TestPondering）
  - テスト総数: 2722件（+82件）
- 2026-01-26: Phase 67 完了（Engine Stability Improvements）
  - I/O例外ハンドリング強化
  - スレッド安全性の向上
  - PRs: #203
- 2026-01-26: Phase 66 完了（Post-54 品質強化）
  - A) ゲームラベル括弧バランス保証:
    - 新規: `_ensure_balanced_brackets()` - 2パスアルゴリズムで正しいネスト保証
    - 新規: `_smart_truncate()` - 長さ制限＋括弧バランス保証
    - 新規: `format_game_display_label()` - 表示ラベル生成（エスケープモード対応）
    - 新規: `format_game_link_target()` - URLエンコード統一
  - B) Weakness Hypothesisエビデンス追加:
    - 新規: `EvidenceMove` dataclass - 軽量エビデンスホルダー
    - 新規: `_select_evidence_moves()` - ゲーム重複排除＋決定論的選択
    - 新規: `_format_evidence_with_links()` - Markdown安全フォーマット（バッククォート使用）
  - C) Style信頼度ゲート:
    - 新規: `STYLE_CONFIDENCE_THRESHOLD = 0.2` - 20%未満で「不明」表示
    - 更新: 勝負術セクション非表示（信頼度 < 20%時）
  - D) MTag単一タグフォールバック:
    - 更新: Priority 11b追加（atari→CAPTURE_RACE_LOSS, low_liberties→READING_FAILURE, endgame_hint→ENDGAME_SLIP）
    - 効果: UNCERTAIN分類が減少
  - E) ミスカテゴリラベルローカライズ:
    - 新規: `get_mistake_category_label()` - i18n経由でラベル取得
    - 新規i18nキー: `mistake:good`, `mistake:inaccuracy`, `mistake:mistake`, `mistake:blunder`
  - F) Top Mistake Types明確化:
    - 更新: UNCERTAIN除外後の分類済み件数を分母に使用
    - 更新: ローカライズ注記（分類済み/UNCERTAIN/その他件数表示）
  - 新規: `tests/test_report_invariants.py`（40件）
  - テスト総数: 2640件（+39件）
- 2026-01-26: Phase 65 完了（Post-54 Integration Tests）
  - 新規: `tests/test_post54_integration.py`（10テスト）
    - `TestStylePacingRiskContract`: Style, Pacing, Risk契約テスト
    - `TestCuratorEndToEnd`: Curator出力スキーマ・決定性テスト
    - `TestBatchWithCurator`: バッチ処理統合テスト
    - `TestBatchPerformance`: パフォーマンステスト（@slow）
  - 新規: `tests/test_regression_post54.py`（12テスト）
    - `TestRegressionExistingFeatures`: APIシグネチャ回帰テスト
    - `TestRegressionGracefulHandling`: 欠損データ対応テスト
  - 機能:
    - Phase 55-64の4機能（Style, Pacing, Risk, Curator）統合テスト
    - 既存ゴールデンテストとの互換性確認
    - 契約レベルのアサーション（内部実装に依存しない）
  - テスト総数: 2601件（+22件）
- 2026-01-25: Phase 61 完了（Risk Context Core）
  - 新規: `katrain/core/analysis/risk/` パッケージ
    - `models.py`（~210行）: Enum + Dataclass定義
      - `RiskJudgmentType`: WINNING, LOSING, CLOSE
      - `RiskBehavior`: SOLID, COMPLICATING, NEUTRAL
      - `RiskContext`: 手ごとのリスク分析コンテキスト
      - `RiskAnalysisConfig`: 閾値設定
      - `PlayerRiskStats`: プレイヤー別統計
      - `RiskAnalysisResult`: 分析結果
    - `analyzer.py`（~320行）: 分析ロジック
      - `analyze_risk()`: メインエントリポイント
      - `to_player_perspective()`: Black視点→手番視点変換
      - `determine_judgment()`: 形勢判定（AND条件）
      - `determine_behavior_from_stdev()`: delta_stdevから行動分類
      - `determine_behavior_from_volatility()`: volatilityから行動分類
      - `check_strategy_mismatch()`: 戦略ミスマッチ検出
    - `__init__.py`（~60行）: 公開API
  - 機能:
    - ScoreStdev利用時: delta_stdev計算（post - pre）
    - ScoreStdev不在時: volatilityフォールバック（母集団標準偏差）
    - 視点変換: Black視点→手番視点（WRとScoreを反転）
    - 判定閾値: inclusive（>=, <=）
    - 戦略ミスマッチ: WINNING+COMPLICATING, LOSING+SOLID
    - 堅牢なdictアクセス（KeyError/TypeErrorをリークしない）
  - 更新: `katrain/core/analysis/__init__.py`（+30行）
  - 新規: `tests/test_risk_analyzer.py`（69件）
  - テスト総数: 2477件
- 2026-01-25: Phase 60 完了（Pacing/Tilt Integration）
  - 新規: `katrain/core/reports/sections/time_section.py`（~110行）
    - `_format_time_management()`: Time Managementセクション生成
    - 早打ち/長考の悪手率計算
    - ティルトエピソード検出結果表示
  - 更新: `katrain/core/analysis/time/pacing.py`
    - `get_pacing_icon()`: PacingMetrics → アイコン変換（🐇/🐢/🔥）
    - `extract_pacing_stats_for_summary()`: サマリ用統計抽出
  - 更新: `katrain/core/reports/karte_report.py`
    - Important Moves表にTime列（アイコン）追加
    - `parse_time_data()`/`analyze_pacing()`統合
  - 更新: `katrain/gui/features/summary_formatter.py`
    - Time Managementセクション統合
  - 更新: `katrain/i18n/locales/*/katrain.po`（25キー追加）
  - 新規: `tests/test_time_section.py`
  - テスト修正: MagicMock無限ループ防止（6テストファイル）
    - `game.root.children = []` 設定追加
    - fixture scope を `class` に変更（Kivy再初期化削減）
  - テスト総数: 2399件
- 2026-01-25: Phase 59 完了（Pacing & Tilt Core）
  - 更新: `katrain/core/analysis/time/pacing.py`（新規、~360行）
    - `analyze_pacing()`: メインエントリポイント
    - `PacingConfig`: 設定パラメータ dataclass
    - `PacingMetrics`: 手ごと分類 dataclass
    - `TiltEpisode`: 連鎖ミスエピソード dataclass
    - `TiltSeverity`: 重大度 Enum（MILD/MODERATE/SEVERE）
    - `GamePacingStats`: ゲーム統計 dataclass
    - `LossSource`: 損失ソース Enum（SCORE/LEELA/POINTS/NONE）
  - 機能:
    - プレイヤー別メディアン基準で早打ち/長考判定
    - Strict '>' トリガー条件でティルトエピソード検出
    - p90損失を超える連鎖ミスをグループ化
    - Best-effort coverage gap handling
    - 混合エンジン検出（KataGo + Leela）
    - 決定論的Severity分類（SEVERE > MODERATE > MILD）
  - 更新: `katrain/core/analysis/time/__init__.py`
    - Phase 59 exports追加
  - 新規: `tests/test_pacing.py`（42件）
  - テスト総数: 2392件
- 2026-01-25: Phase 58 完了（Time Data Parser）
  - 新規: `katrain/core/analysis/time/` パッケージ
    - `models.py`: TimeMetrics, GameTimeData dataclass
    - `parser.py`: parse_time_data(), _extract_time_left()
    - `__init__.py`: 公開API exports
  - 機能:
    - SGF時間タグ（BL/WL）の解析・正規化
    - 手ごとの消費時間計算（差分計算）
    - 整数・小数形式対応（IGS/KGS等）
    - 浮動小数点許容誤差（EPS=0.001）
    - Graceful degradation:
      - 時間データなし → has_time_data=False
      - タグ欠損 → time_left_sec=None
      - 秒読みリセット → time_spent_sec=None + 警告ログ
  - 更新: `docs/01-roadmap.md`
    - Phase 58 受け入れ条件を詳細化
  - 新規: `tests/test_time_parser.py`（22件）
  - テスト総数: 2341件
- 2026-01-25: Phase 57 完了（Style Karte Integration）
  - 更新: `katrain/core/reports/karte_report.py`
    - `_build_tag_counts_from_moves()`: MeaningTagIdカウント集計
    - `_compute_style_safe()`: スタイル計算（エラー時None返却）
    - Meta出力にStyle/Style Confidence行追加
  - 更新: `katrain/i18n/locales/*/katrain.po`
    - 6件のスタイル名i18nキー追加（en/jp）
    - `style:kiai_fighter:name` → "Kiai Fighter" / "剛腕ファイター"
    - `style:cosmic_architect:name` → "Cosmic Architect" / "大局観の建築家"
    - `style:precision_machine:name` → "Precision Machine" / "精密機械"
    - `style:shinobi_survivor:name` → "Shinobi Survivor" / "忍びの生存者"
    - `style:ai_native:name` → "AI Native" / "AI世代"
    - `style:balance_master:name` → "Balance Master" / "バランスマスター"
  - 新規: `tests/test_karte_style_integration.py`（12件）
  - ゴールデンファイル更新（4件）
  - テスト総数: 2319件
- 2026-01-25: Phase 56 完了（Style Archetype Core）
  - 新規: `katrain/core/analysis/style/` パッケージ
    - `models.py`: StyleArchetypeId, StyleArchetype, StyleResult, STYLE_ARCHETYPES
    - `analyzer.py`: determine_style(), compute_confidence(), scores_are_tied()
    - `__init__.py`: 公開API exports
  - 6アーキタイプ定義:
    - KIAI_FIGHTER（剛腕ファイター）: Fighting高、Stability低
    - COSMIC_ARCHITECT（天空の構想家）: Opening高、Endgame低
    - PRECISION_MACHINE（精密機械）: Endgame高、Fighting低
    - SHINOBI_SURVIVOR（シノビの達人）: Stability高、Opening低
    - AI_NATIVE（新人類）: Awareness高
    - BALANCE_MASTER（バランスマスター）: フォールバック
  - 判定ロジック:
    - 相対評価: 5軸平均からの偏差で判定
    - バランス優先ルール: max|deviation| < 0.5 → 常にBALANCE_MASTER
    - 決定論的タイブレーク: Enum定義順
    - 浮動小数点tolerance: math.isclose(abs_tol=1e-9)
  - 新規: `tests/test_style_analyzer.py`（30件）
  - テスト総数: 2307件
- 2026-01-25: Phase 55 完了（Report Foundation + User Aggregation）
  - 新規: `katrain/core/reports/` レポート基盤
    - `sections/registry.py`: セクションレジストリ
    - `sections/types.py`: SectionRegistration, SectionWriter型定義
  - 新規: `katrain/core/analysis/user_aggregate.py`
    - UserAggregateStore: ユーザー別レーダー履歴管理
    - GameRadarEntry, UserRadarAggregate dataclass
  - テスト総数: 2277件
- 2026-01-25: Phase 54 完了（Report Quality Improvements）
  - 新規: `escape_markdown_table_cell()` 追加（helpers.py）
    - テーブルセルの安全なエスケープ（`[`, `]`, `|`, 改行対応）
  - 更新: `katrain/core/batch/stats.py`
    - `lang` パラメータ追加（`run_batch()`, `build_player_summary()`）
    - 12+ローカライズヘルパー関数追加（JP/EN両言語対応）
    - タグベース練習ヒント追加（MeaningTag / ReasonTag）
    - パーセンテージ注記追加
    - 色偏り注記追加（全黒番/白番の注意書き）
  - 更新: `katrain/core/batch/orchestration.py`
    - `lang` パラメータ追加
  - 更新: `katrain/core/reports/karte_report.py`
    - WR Gap説明改善（JP/EN両言語対応）
  - 新規テスト: `TestEscapeMarkdownTableCell`（9件）
  - ゴールデンファイル更新（カルテ＋サマリ）
  - テスト総数: 2237件
- 2026-01-24: Phase 53 完了（Batch Report基盤）
  - 新規: `katrain/core/batch/helpers.py` にヘルパー関数追加
    - `truncate_game_name()`: ゲーム名短縮（head+tail保持）
    - `format_wr_gap()`: WR Gap表示フォーマット（クランプ＋精度）
    - `make_markdown_link_target()`: マークダウンリンク生成（URL-encode対応）
  - 更新: `katrain/core/batch/stats.py`
    - Top 10 Worst Movesテーブルに「カルテ」列追加
    - `build_player_summary()` 署名更新（karte_path_map, summary_dir）
  - 更新: `katrain/core/batch/orchestration.py`
    - `karte_path_map` 構築＋サマリビルダーへ渡す
  - 更新: `katrain/core/reports/karte_report.py`
    - "Best Gap" → "WR Gap" リネーム
    - WR Gap表示精度改善
  - 更新: `katrain/core/analysis/presentation.py`
    - `get_auto_confidence_label()` 追加（推定確度 vs 信頼度 分離）
  - ローカライズ: "Practice Priorities" → "練習の優先順位"
  - 新規: `tests/test_batch_helpers.py`（12件）
  - ゴールデンファイル更新（カルテ＋サマリ）
  - テスト総数: 2199件
- 2026-01-24: Phase 52 完了（Stabilization & Documentation）
  - PR-1（B1）: `docs/02-code-structure.md` を Phase 21-52 に対応
    - 10モジュールのセクション追加（skill_radar, critical_moves, meaning_tags, lexicon等）
  - PR-2（B2）: Radar ゴールデンテスト実装
    - 新規: `tests/test_golden_radar.py`（17件: 15 P0 + 2 P1）
    - 追加: `tests/conftest.py` に `round_half_up()`, `_stabilize_float()`, `normalize_radar_output()`
    - 新規: `tests/fixtures/golden/radar_*.golden.json`（2ファイル）
    - 3段階ワークフロー: 生成→3回安定性検証→変更なし確認
  - PR-2（B3）: スキップテスト理由更新
    - `test_critical_moves.py` の4件を Phase 53 延期
    - バグ発見: `select_critical_moves` が未定義 `build_eval_snapshot` をインポート
  - PR-3（B4）: ベンチマークスクリプト作成
    - 新規: `scripts/benchmark_batch.py`（~180行）
    - `extract_game_stats()` のパフォーマンス計測
    - `--threshold`, `--strict` オプション対応
  - PR-3（B5）: ドキュメント最終化
    - 更新: `CLAUDE.md`（Phase 52 完了エントリ）
    - 更新: `docs/01-roadmap.md`（Phase 52: 完了ステータス）
  - テスト総数: 2187件
- 2026-01-23: Phase 52-A 完了（Tofu Fix + Language Code Consistency）
  - 新規: `katrain/common/locale_utils.py`（~100行）
    - `normalize_lang_code()`: 内部正規コード（"en"/"jp"）への変換
    - `to_iso_lang_code()`: ISO 639-1コード（"en"/"ja"）への変換
    - 地域バリアント対応: "ja_JP", "ja-JP" → "jp"
    - 大文字小文字非依存: "JP", " jp " → "jp"
  - 更新: `katrain/common/__init__.py`（エクスポート追加）
  - 更新: `katrain/core/analysis/meaning_tags/integration.py`
    - `normalize_lang = to_iso_lang_code` エイリアス（後方互換）
  - 豆腐修正: 以下のウィジェットに`font_name=Theme.DEFAULT_FONT`追加
    - `quiz_popup.py`: header_label, btn, start_button, close_button
    - `settings_popup.py`: search_input, search_clear_btn, タブヘッダー
    - `popups.kv`: LabelledTextInput, LabelledPathInput
  - テスト25件追加（test_locale_utils.py）
  - テスト総数: 2186件
- 2026-01-23: Phase 51 完了（Radar UI Widget）
  - 新規: `katrain/gui/widgets/radar_geometry.py`（~150行）
    - 純粋幾何関数（Kivy非依存、CI安全）
    - `calculate_vertex()`: 軸インデックス＋スコアから座標計算
    - `get_label_position()`: 軸ラベル位置（calculate_vertexと同じ角度公式）
    - `tier_to_color()`: Tier文字列→RGBA色変換
    - 座標系: 軸0（Opening）が12時、時計回り（角度減少）
  - 新規: `katrain/gui/widgets/radar_chart.py`（~160行）
    - `RadarChartWidget`: RelativeLayout継承、DictProperty安全パターン
    - グリッドリング固定比率（20%, 40%, 60%, 80%, 100%）
    - `Clock.create_trigger()`でデバウンス再描画
    - 頂点ドット色分け（Tier 4-5緑、3黄、1-2赤、unknown灰）
  - 新規: `katrain/gui/features/skill_radar_popup.py`（~200行）
    - Black/Whiteタブ切替（既存i18nキー再利用）
    - 弱軸（Tier 1-2）ハイライト表示
    - 19x19制限、MIN_MOVES_FOR_RADAR検証
  - 更新: `katrain/__main__.py`（`_do_skill_radar_popup()`追加）
  - 更新: `katrain/gui.kv`（MyKatrainメニュー項目追加）
  - 更新: `katrain/i18n/locales/*/katrain.po`（9キー追加）
  - テスト45件追加（31 geometry + 14 popup）
  - テスト総数: 2161件
- 2026-01-23: Phase 50 完了（Critical 3 Focused Review Mode）
  - 新規: `katrain/core/analysis/critical_moves.py`（~455行）
    - `CriticalMove` frozen dataclass: LLMプロンプト生成用14フィールド
    - `select_critical_moves()`: 重要度ベース選択（多様性ペナルティ付き）
    - `MEANING_TAG_WEIGHTS`: 12タグの学習価値重み（life_death_error=1.5等）
    - `DIVERSITY_PENALTY_FACTOR = 0.5`: タグ重複時のペナルティ係数
    - Decimal ROUND_HALF_UP: 決定論的丸め（同じゲーム→同じ結果）
  - 更新: `katrain/core/reports/karte_report.py`
    - `_critical_3_section_for()`: Critical 3セクション生成（Markdown/JSON）
    - `CRITICAL_3_PROMPT_TEMPLATE`: LLMプロンプトテンプレート
    - `build_critical_3_prompt()`: プロンプトビルダー関数
  - 更新: `katrain/core/analysis/__init__.py`（再エクスポート追加）
  - 新規: `tests/helpers_critical_moves.py`（~302行）
    - `StubGameNodeWithAnalysis`: analysis data付きスタブ
    - `build_stub_game_with_analysis()`: テスト用ゲームビルダー
    - `create_test_snapshot()`, `create_test_snapshot_with_tags()`
  - テスト50件追加（36 unit + 14 integration）
  - テスト総数: 2116件
- 2026-01-23: Phase 49 完了（Radar Aggregation & Summary Integration）
  - 更新: `katrain/core/analysis/skill_radar.py`（+357行）
    - `AggregatedRadarResult` frozen dataclass: 複数局集約結果
    - `aggregate_radar()`: 均等重み、per-axis UNKNOWNフィルタリング
    - `radar_from_dict()`: roundtripシリアライゼーションヘルパー
    - `round_score()`: Decimal ROUND_HALF_UPで決定論的丸め
    - 定数: `MIN_VALID_AXES_FOR_OVERALL=3`, `MIN_MOVES_FOR_RADAR=10`
  - 更新: `katrain/core/batch/stats.py`（+196行）
    - `extract_game_stats()`: radar_by_player計算（19x19のみ）
    - `build_player_summary()`: Skill Profileセクション追加
    - 定数: `TIER_LABELS`, `AXIS_LABELS`, `AXIS_PRACTICE_HINTS`
  - 更新: `__init__.py`（再エクスポート追加）
  - i18n: EN/JP radar tier/axis翻訳キー追加（13キー）
  - テスト60件追加（38 aggregation + 22 integration）
  - テスト総数: 2066件
- 2026-01-23: Phase 48 完了（5-Axis Radar Data Model）
  - 新規: `katrain/core/analysis/skill_radar.py`（~570行）
    - `RadarAxis` enum: 5軸（Opening, Fighting, Endgame, Stability, Awareness）
    - `SkillTier` enum: TIER_1-5 + TIER_UNKNOWN（str継承、int mapping付き）
    - `RadarMetrics` frozen dataclass: MappingProxyTypeでimmutability保証
    - Tier変換関数: APL/BlunderRate/MatchRate → Tier（半開区間閾値）
    - `is_garbage_time()`: BLACK視点winrate >= 0.99 or <= 0.01
    - `compute_overall_tier()`: 5軸median、math.ceil for even counts
    - `compute_radar_from_moves()`: MoveEvalリストから5軸計算
  - 更新: `__init__.py`（再エクスポート追加）
  - 制約: 19x19のみ（OPENING_END_MOVE=50, ENDGAME_START_MOVE=150）
  - テスト95件追加
  - テスト総数: 2006件
- 2026-01-23: Phase 47 完了（Meaning Tags Integration）
  - 新規: `katrain/core/analysis/meaning_tags/integration.py`
    - `normalize_lang()`: 言語コード正規化（"jp" → "ja"）
    - `get_meaning_tag_label_safe()`: 安全なラベル取得（None対応）
    - `format_meaning_tag_with_definition()`: 30文字truncation付き表示
  - MoveEval拡張: `meaning_tag_id: Optional[str]`フィールド追加
  - batch/stats.py: `meaning_tags_by_player`統計、Top 3 Mistake Typesセクション
  - karte_report.py: `lang`パラメータ、MTag列、JSON meaning_tagオブジェクト
  - Python 3.9互換性修正（`float | None` → `Optional[float]`）
  - テスト49件追加
  - テスト総数: 1946件
- 2026-01-23: Phase 46 完了（Meaning Tags System Core）
  - 新規: `katrain/core/analysis/meaning_tags/`パッケージ
    - `models.py`: MeaningTagId enum（str継承）、MeaningTag dataclass（frozen）
    - `registry.py`: MEANING_TAG_REGISTRY（12タグ定義、5つにLexiconアンカー）
    - `classifier.py`: 分類ヒューリスティクス（~500行）
    - `__init__.py`: 公開API + 閾値定数エクスポート
  - 12タグ分類: missed_tesuji, overplay, slow_move, direction_error, shape_mistake,
    reading_failure, endgame_slip, connection_miss, capture_race_loss,
    life_death_error, territorial_loss, uncertain
  - ヘルパー: get_loss_value(), classify_gtp_move(), compute_move_distance(), is_endgame()
  - Lexicon統合: resolve_lexicon_anchor()（モックフレンドリー設計）
  - テスト197件追加（classifier 93 + models 24 + registry 73 + integration 7）
  - テスト総数: 1867件
- 2026-01-23: Phase 45 完了（Lexicon Core Infrastructure）
  - 新規: `katrain/common/lexicon/`パッケージ（Kivy非依存）
    - `models.py`: frozen dataclass（LexiconEntry, DiagramInfo, AIPerspective）
    - `validation.py`: 2段階パイプライン + 例外クラス
    - `store.py`: LexiconStoreクラス（スレッドセーフ、アトミックスナップショット）
    - `__init__.py`: 公開API + get_default_lexicon_path()
  - 設計: 完全イミュータブル（frozen=True + Tuple[str, ...]）
  - 機能: get(), get_by_title(), get_by_category(), get_by_level()
  - バリデーション: 必須フィールド、Level 3専用、参照ID、タイトル衝突
  - 環境変数: LEXICON_PATH でパスオーバーライド可能
  - 依存: PyYAML追加（pyproject.toml）
  - テスト111件追加
  - テスト総数: 1665件
- 2026-01-21: Phase 44 完了（Batch Analysis Fixes）
  - Issue 1: 信頼性閾値の一貫性修正
    - `target_visits`パラメータを`extract_game_stats()`, `build_karte_report()`に追加
    - カウントと表示で同じ有効閾値を使用（例: visits=100→threshold=90）
    - 修正: batch/stats.py, batch/orchestration.py, karte_report.py, game.py
  - Issue 2: バッチ完了チャイム
    - 新規: `tools/generate_chime.py`（Python標準ライブラリのみでWAV生成）
    - 新規: `katrain/sounds/complete_chime.wav`（A major chord、0.4秒）
    - 定数: `Theme.COMPLETION_CHIME_SOUND`追加
    - 更新: batch_core.pyで石音の代わりにチャイムを使用
  - テスト7件追加
  - テスト総数: 1554件
- 2026-01-20: Phase 43 完了（Stability Audit）
  - Issue 1 (P0): Config save atomic化（tempfile + os.replace + os.fsync）
  - Issue 2 (P0): save_config() エラーハンドリング（`_save_config_with_errors()`抽出）
  - Issue 3 (P1): Leela shutdown TimeoutExpired二重発生対応
  - Issue 4 (P1): LeelaEngine analysis thread join（kill後に実行）
  - Issue 5 (P2): Theme loader新規モジュール（encoding + hasattr）
  - 新規: `katrain/gui/theme_loader.py`（~35行）
  - テスト18件追加（4ファイル）
  - テスト総数: 1529件
- 2026-01-20: Phase 42-C 完了（Batch Import Tests）
  - 新規: `tests/test_batch_core_imports.py`（19件）
  - 後方互換テスト: tools.batch_analyze_sgfからのインポート検証
  - 新APIテスト: core.batchからのインポート検証
  - 動作テスト: parse_timeout, get_canonical_loss, safe_int等
  - テスト総数: 1511件
- 2026-01-20: Phase 42-B 完了（Batch Orchestration移行）
  - 新規: `katrain/core/batch/analysis.py`（~394行、analyze_single_file, analyze_single_file_leela）
  - 新規: `katrain/core/batch/orchestration.py`（~439行、run_batch）
  - 新規: `katrain/core/batch/stats.py`（~961行、extract_game_stats, build_player_summary等）
  - 拡張: `__init__.py`にlazy `__getattr__`追加（重量モジュールの遅延インポート）
  - 軽量化: tools/batch_analyze_sgf.py（~1900行→~240行、CLI + 再エクスポートのみ）
  - 更新: gui/features/batch_core.py, batch_ui.pyのインポート先変更
  - テスト総数: 1492件
- 2026-01-20: Phase 42-A 完了（Batch Core移行）
  - 新規: `katrain/core/batch/`パッケージ（Kivy非依存）
  - models.py: WriteError, BatchResult dataclass
  - helpers.py: 純粋関数15種（choose_visits_for_sgf, safe_int, needs_leela_karte_warning等）
  - 後方互換: tools/batch_analyze_sgf.pyから再エクスポート
  - アーキテクチャテスト: test_batch_does_not_import_kivy()追加
  - テスト総数: 1492件
- 2026-01-20: Phase 41 完了（コード品質リファクタリング）
  - Phase 41-A: `AnalysisMode(str, Enum)` + `parse_analysis_mode()`関数（constants.py）
  - Phase 41-B: コマンドハンドラ抽出（gui/features/commands/パッケージ新設）
  - Phase 41-C: 例外ハンドリング改善（`# noqa: BLE001`、OUTPUT_ERROR統一）
  - Phase 41-D: Magic Number定数化（AI_ACCURACY_DECAY_BASE等3定数）
  - テスト14件追加（test_analysis_mode.py）
  - テスト総数: 1491件
- 2026-01-19: Phase 40 完了（Leela Zero対戦機能）
  - AI_LEELA定数追加（constants.py）、AI_STRATEGIES/RECOMMENDED_ORDER/STRENGTH統合
  - LeelaStrategy + LeelaNotAvailableError実装（ai.py、~90行）
  - config.json: `ai:leela: {}`と`leela.play_visits: 500`追加
  - __main__.py: LeelaNotAvailableErrorキャッチ＋ステータスバー表示
  - settings_popup.py: Play Visits UI追加
  - i18n: EN/JP翻訳追加（10キー）
  - テスト14件（test_leela_strategy.py）
  - テスト総数: 1477件
- 2026-01-19: Phase 39 完了（エンジン比較ビュー）
  - PR-1: `katrain/core/analysis/engine_compare.py`（~400行）
    - `ComparisonWarning` enum、`MoveComparison`/`EngineStats`/`EngineComparisonResult` dataclass
    - `build_comparison_from_game()` 関数
    - `compute_spearman_manual()` 手動Spearman相関（scipy不使用）
  - PR-1: テスト38件（test_engine_compare.py）
  - PR-2: `katrain/gui/features/engine_compare_popup.py`（~660行）
    - タブ切替UI（手別比較 / 統計サマリー）
    - ScrollView固定 + 乖離フィルタ（デフォルトON）
    - 行クリックで該当手にジャンプ
  - PR-2: MyKatrainメニューに「エンジン比較」項目追加
  - PR-2: i18n 35+キー追加（en/jp）
  - テスト総数: 1463件
- 2026-01-18: Phase 38 完了（安定化）
  - PR-1: `_safe_int()` ヘルパー関数（batch_core.py、サイレントデフォルト処理）
  - PR-1: `save_manifest()`, `save_player_profile()` にtry-except追加（io.py）
  - PR-1: `BaseEngine.on_error` のprint()削除、サブクラスでオーバーライド
  - PR-1: `_stderr_thread` のprint()をkatrain.log()に変更（engine.py）
  - PR-1: shutdown例外にOUTPUT_EXTRA_DEBUGログ追加（engine.py）
  - PR-1: `extract_analysis_from_sgf_node()` 例外具体化 + binasciiインポート（summary_stats.py）
  - PR-1: テスト8件（test_batch_validation.py）
  - PR-2: Game初期化/playテスト9件（test_game_core.py、test_board.pyパターン踏襲）
  - テスト総数: 1425件
- 2026-01-18: Phase 37 完了（テスト強化）
  - PR-2: `MixedEngineSnapshotError` 専用例外導入（karte_report.py）
  - PR-2: `KARTE_ERROR_CODE_*` エラーコード定数導入
  - PR-2: `is_single_engine_snapshot()` 混合エンジン検出関数
  - PR-2: `needs_leela_karte_warning()` 純粋関数（batch_core.py）
  - PR-2: T1混合エンジン防止テスト（test_mixed_engine_guard.py、17件）
  - PR-2: T2 Leela+karte警告テスト（test_batch_engine_option.py拡張）
  - PR-2: T3 resolve_visits契約テスト（定数参照、test_analysis_strength.py）
  - PR-2: T4 config fallback契約テスト（test_analysis_engine_config.py）
  - PR-3: T6 Leelaゴールデンテスト（test_golden_karte.py、3件）
  - PR-3: ゴールデンファイル（karte_leela_standard.golden）
  - PR-3: UI visits_input disabled（Leela選択時、batch_ui.py）
  - テスト総数: 1408件
- 2026-01-18: Phase 36 完了（Leelaバッチ解析）
  - PR-2: `analyze_single_file_leela()` per-move解析関数（~180行）
  - PR-2: `run_batch()` 拡張（analysis_engine, leela_engine, per_move_timeout）
  - PR-2: エンジン検証（バッチ開始時Leela aliveチェック）
  - PR-2: テスト13件（test_batch_leela_analysis.py）
  - PR-1: `LeelaEngine.is_idle()` メソッド（スレッドセーフ）
  - PR-1: `cancel_analysis()` ロック保護
  - PR-1: Batch UIエンジン選択行（KataGo/Leela切替）
  - PR-1: `collect_batch_options()` に `analysis_engine` 追加
  - PR-1: i18n 5キー追加
  - PR-1: テスト22件（test_leela_engine_idle.py, test_batch_engine_option.py）
  - 制限: Leelaカルテ生成は未対応（Phase 36 MVP）
- 2026-01-18: Phase 35 完了（Leelaカルテ統合）
  - 新規: `has_loss_data()` 関数（MoveEvalに損失データが存在するか判定）
  - 新規: `format_loss_with_engine_suffix()` 関数（Leelaは「(推定)」サフィックス付き）
  - 拡張: `worst_move_for()` がLeela対応（has_loss_data()ベースで0.0も候補に含む）
  - 拡張: `summary_lines_for()`, `opponent_summary_for()` のworst move表示
  - 拡張: Important Moves table の Loss 列にエンジンサフィックス
  - テスト: 21件（test_karte_leela_integration.py）
- 2026-01-18: Phase 33 完了（エンジン選択設定）
  - 新規: `VALID_ANALYSIS_ENGINES: FrozenSet[str]`（EngineTypeから派生、UNKNOWN除外）
  - 新規: `DEFAULT_ANALYSIS_ENGINE` 定数（"katago"）
  - 新規: `get_analysis_engine()` 関数（unhashable型ガード付き）
  - 設定: `engine.analysis_engine` キー追加
  - テスト: 30件（test_analysis_engine_config.py）
- 2026-01-18: Phase 32 完了（レポートLeela対応）
  - 新規: `EngineType` enum（KATAGO/LEELA/UNKNOWN）
  - 新規: `detect_engine_type()` 関数（MoveEvalからエンジン種別推定）
  - 拡張: `get_canonical_loss_from_move()` にleela_loss_est対応+全クランプ
  - 新規: `format_loss_label()` 関数（エンジン種別ラベルフォーマット）
  - 更新: `format_evidence_examples()`, `karte_report.py` Leela対応
  - テスト: 35件（test_engine_type_labels.py）
- 2026-01-18: Phase 31 完了（Leela→MoveEval変換）
  - 新規: `katrain/core/leela/conversion.py`（変換モジュール、~280行）
  - 新規: `MoveEval.leela_loss_est` フィールド（Leela Zero推定損失）
  - 機能: `leela_position_to_move_eval()` 単一手変換
  - 機能: `leela_sequence_to_eval_snapshot()` シーケンス変換（検証付き）
  - 機能: Winrate視点変換（side-to-move → black perspective）
  - テスト: 36件（test_leela_conversion.py）
- 2026-01-18: Phase 30 完了（解析強度抽象化）
  - 新規: `AnalysisStrength` enum（QUICK/DEEP、エンジン共通抽象）
  - 新規: `ENGINE_VISITS_DEFAULTS` 定数（KataGo/Leela別デフォルト値）
  - 新規: `resolve_visits()` 関数（防御的パース、フォールバック付き）
  - 新規: `LEELA_FAST_VISITS_MIN` 定数（UI最小値 50）
  - 設定: `leela.fast_visits` 追加（デフォルト 200）
  - UI: Settings > Leela > Fast Visits 入力欄追加（clampバリデーション付き）
  - テスト: 28件（test_analysis_strength.py）
- 2026-01-17: Phase 29 完了（Diagnostics + Bug Report Bundle）
  - 新規: `common/sanitize.py`（パス/テキストサニタイズ、Kivy非依存）
  - 新規: `core/log_buffer.py`（スレッドセーフな循環ログバッファ）
  - 新規: `core/diagnostics.py`（システム情報収集、ZIP生成）
  - 新規: `gui/features/diagnostics_popup.py`（診断ポップアップUI）
  - 機能: MyKatrain メニュー → Diagnostics で診断画面表示
  - 機能: Bug Report ZIP生成（プライバシー保護付き）
  - テスト: 71件（test_sanitize.py, test_log_buffer.py, test_diagnostics.py）
- 2026-01-17: Phase 28 完了（Smart Kifu運用強化）
  - 新規: `ImportErrorCode` enum（文字列マッチング脆弱性を解消）
  - 新規: `TrainingSetSummary` dataclass（サマリー計算）
  - 拡張: `import_sgf_to_training_set()` に `compute_ratio` オプション追加
  - 新規: `import_analyzed_sgf_folder()` バッチ出力フォルダのインポート
  - 機能: Training Set Manager に解析率表示（色分け付き）
  - 機能: バッチインポートダイアログ（`show_import_batch_output_dialog()`）
  - テスト: 36件（test_smart_kifu_analyzed_ratio.py, test_smart_kifu_import.py）
- 2026-01-17: Phase 27 完了（Settings UIスケーラブル化）
  - 新規: `common/settings_export.py`（Export/Import/Resetロジック、Kivy非依存）
  - 拡張: `gui/features/settings_popup.py`（検索バー、Export/Import/Resetボタン）
  - 機能: 設定検索、設定Export/Import（JSON）、タブ別リセット
  - テスト: 22件（test_settings_export.py）
- 2026-01-17: Phase 26 完了（レポート導線改善）
  - 新規: `common/file_opener.py`（クロスプラットフォームファイル/フォルダオープナー）
  - 新規: `gui/features/report_navigator.py`（レポート導線UI）
  - 機能: 「最新レポートを開く」「出力フォルダを開く」メニュー項目
- 2026-01-17: Phase 24 完了（SGF E2E Regression Tests）
  - 新規: `tests/helpers/` パッケージ（mock_analysis.py, stats_extraction.py）
  - 拡張: `tests/conftest.py`（CI検出、改行正規化）
  - 追加: TestKarteFromSGF, TestSummaryFromSGF（3 SGFファイル対応）
- 2026-01-16: Phase 20 完了、コード構造更新
  - core層のKivy依存を大幅削減（許可リスト6→1エントリ）
  - 新規: `common/platform.py`, `common/config_store.py`, `gui/lang_bridge.py`
  - 変更: `core/lang.py`（Observable→コールバックベース）
- 2025-12-30: v1.0 作成（Claude Code移行対応）
