# Top Moves 難解PVフィルタ（Human Move Filter）設計書ドラフト v0.1

作成日: 2026-01-06  
ステータス: Draft（仕様確定前）  
対象: my-katrain（KaTrain v1.17.0 fork）

---

## 0. この文書の目的

KataGo 解析後に表示される **Top Moves（候補手）** のうち、マウスオーバー等で表示される **PV（変化図）が難しすぎて学習が止まる問題**を解消するため、表示候補手を「人間が理解しやすい範囲」に寄せる **難解PVフィルタ**を導入する。

この文書では **実装前に確定すべき仕様（I/O契約・UX・レベル定義・フォールバック）** を固める。  
（コードの置き場所・具体的なAPI呼び出し・クラス名などは実装段階で決める。）

---

## 1. 背景と問題

### 1.1 現状の問題
- 解析後、盤上の候補手（Top Moves）にマウスオーバーすると表示される PV が難しすぎることがある。
- その結果、候補手の比較や理解が進まず「学習体験」が悪化する。

### 1.2 根本原因（仮説）
- KataGo の候補手は強いが、人間にとって「読み筋が長い」「形勢の揺れが激しい」「勝負手寄り」などの手が混ざりやすい。
- 解析条件（探索数、各種ノイズ/探索パラメータ）により、候補の多様性や安定性が変動する。

---

## 2. ゴール / 非ゴール

### 2.1 ゴール（やること）
- **Top Moves（候補手リスト）をフィルタ**し、難しいPVを含む手を除外して **わかりやすい候補手だけを表示**する。
- 設定で **OFF / WEAK / MEDIUM / STRONG / AUTO** を選べるようにする（デフォルトは OFF）。
- **AI最善手（ベスト）は info 側に常に表示**できるようにし、Top Moves の見やすさと「参照としての最善手」を両立する。
- フィルタが強すぎて候補が消えるケースへの **フォールバック**を定義する。

### 2.2 非ゴール（やらないこと）
- エンジン自体（KataGo）の探索や強さを変えること（※フィルタは「表示・選別」レイヤー）。
- 「正しい手」を人間に最適化するための高度な形勢理解（v1では代理指標で十分）。
- 難解度（MuZero的3分解）などの **局面スコアリング**の導入（別ドキュメントで扱う）。

---

## 3. 用語

- **Top Moves**: 盤上に候補として表示される複数の推奨手（候補手群）。
- **PV（Principal Variation）**: その手を選んだ場合の推定変化図（読み筋）。
- **フィルタ**: 解析済み候補手リストから、一定の基準で「表示対象」を選別する処理。
- **Viewer Level / Viewer Preset**: 「いま理解しやすい解説粒度」を表す概念。v0.2 では Lite / Standard / Deep の3段階プリセットを想定。
- **Skill Level**: 棋力推定や段級位など（推定値で揺れる可能性がある）。

---

## 4. 仕様（I/O契約）

### 4.1 入力
- 単一局面に対する KataGo 解析結果から得られる「候補手一覧」。
- 候補手の各要素には、少なくとも以下が含まれることを想定（名称は実装依存）:
  - move（座標）
  - score / winrate 等の評価値（いずれか）
  - PV（変化列）
  - visits / order 等（可能なら）

### 4.2 出力
- **表示用 Top Moves**（フィルタ後の候補手リスト）
- **参照用 Best Move**（常に表示できる最善手情報。フィルタの対象外の“別枠”）

> 注: ここでの「別枠」とは、Top Moves の“盤上候補表示”からは外しても、info欄などに表示できるという意味。

---

## 5. UX / 設定

### 5.1 設定項目
- `Human Move Filter`（難解PVフィルタ）
  - `OFF`（デフォルト）
  - `WEAK`
  - `MEDIUM`
  - `STRONG`
  - `AUTO`（Viewer / Skill 連動）

### 5.2 AUTO の決定規則（推奨）
1. **Viewer Preset が利用可能ならそれを優先**（体験の粒度に直結するため）
2. Viewer が未設定/不明なら **Skill Level を fallback**（初期提案用）
3. それも不明なら `MEDIUM` を既定値として適用

#### 推奨マッピング（v1）
- Viewer Preset:
  - Lite → STRONG
  - Standard → MEDIUM
  - Deep → WEAK（※Deepでも“難解すぎるPVで学習が止まる”は起こり得るため、最低限のガードとしてWEAKを残す）

### 5.3 UI表示（安心設計）
- `AUTO` 選択時は **実際に適用中の強度を明示**する  
  例: `AUTO（Standard → MEDIUM）`
- Viewer 未設定で fallback した場合も明示  
  例: `AUTO（Viewer未設定 → MEDIUM）`

---

## 6. フィルタ基準（難解の代理指標）

v1 は「PVが難しい」を直接測定せず、次の代理指標で落とす。

### 6.1 パラメータ
- `max_candidates`: 解析候補のうち、まず上位何手までを母集団として見るか
- `max_score_loss`: 最善手からのスコア損失の許容（目）
- `max_winrate_loss`: 最善手からの勝率損失の許容
- `max_pv_length`: PVが長すぎる手を除外（読み筋が長い＝難しい可能性）
- `max_score_swing`: その手を選ぶと評価が大きく揺れる手を除外（激しい/勝負手寄りの可能性）

> 重要: これは「分かりやすい候補を提示する」ための近似であり、棋力最適化ではない。

---

## 7. レベル別 初期値（v1案）

> v1 はまずこの初期値で開始し、運用フィードバックで調整する（閾値は後で変更できるようにする）。

### 7.1 WEAK（弱）
| パラメータ | 値の例 | 意味 |
|---|---:|---|
| max_candidates | 5〜6 | 上位5〜6手だけを見る |
| max_score_loss | 1.0 目 | 最善から1目以内だけ許可 |
| max_winrate_loss | 0.02 | 勝率 −2% まで |
| max_pv_length | 12 | かなり長い読みも許容 |
| max_score_swing | 4.0 目 | 勝負手もかなり通す |

用途: 「AIの暴れ方を少し抑えたい」上級者向け。

### 7.2 MEDIUM（中）
| パラメータ | 値の例 | 意味 |
|---|---:|---|
| max_candidates | 10 | 上位10手まで採用候補 |
| max_score_loss | 2.0 目 | 最善から2目まで許容 |
| max_winrate_loss | 0.03 | 勝率 −3% まで |
| max_pv_length | 8 | 読み筋が長すぎる手は除外 |
| max_score_swing | 2.5 目 | 一手で大きく振れる手は減らす |

用途: 一般ユーザー〜高段者の標準。

### 7.3 STRONG（強）
| パラメータ | 値の例 | 意味 |
|---|---:|---|
| max_candidates | 20〜30 | 上位20〜30手まで広く見る |
| max_score_loss | 3.0〜4.0 目 | 多少の損は完全に許容 |
| max_winrate_loss | 0.05 | 勝率 −5% まで |
| max_pv_length | 6 | 読み筋が長い手はほぼ全部カット |
| max_score_swing | 1.5〜2.0 目 | 一手で形勢が大きく動く手はほぼ禁止 |

用途: 「分かりやすさ＞＞＞強さ」を最大化（初心者〜級位者寄り）。

---

## 8. 選別ロジック（v1の決め）

### 8.1 基本手順
1. 解析候補から上位 `max_candidates` を母集団として取り出す（順位基準は実装で統一）
2. 各候補について、以下の“いずれか”を満たす場合に除外:
   - score_loss > max_score_loss
   - winrate_loss > max_winrate_loss
   - pv_length > max_pv_length
   - score_swing > max_score_swing
3. 残った候補を Top Moves として表示

### 8.2 フォールバック（重要）
- フィルタの結果が 0 手になった場合:
  - **最低1手は表示する**（例: 最善手の次点、または母集団の先頭）
- フィルタの結果が極端に少ない場合:
  - 表示数を補うために “条件を緩めて再実行” は v1 ではしない（挙動が読みにくくなるため）
  - 代わりに「候補が少ない理由」をUIで説明できるとよい（将来）

### 8.3 「最善手」の扱い
- Top Moves（盤上候補表示）からはフィルタで落ち得る
- ただし **info欄などに“最善手（AI best）”を別枠で表示**できるようにする  
  →「最善は知りたいが、候補群は易しくしたい」を両立

### 8.4 “生PV”へのアクセス（逃げ道）
- フィルタを掛けても、ユーザーが必要なら **元PV（raw）を見れる導線**を残す
  - 例: info欄のベストPV、または「候補一覧パネルで raw 表示に切替」など

---

## 9. 解析条件（探索数 / wide root noise 等）への注意書き

### 9.1 重要な前提
このフィルタは「解析結果の候補手リスト」を加工するだけで、**エンジンが出してこない手を新しく生成できない**。  
つまり、解析条件によっては「候補自体が少ない / 似た手しか出ない」ことがある。

### 9.2 wide root noise に関する注意（ユーザー要望）
- wide root noise を 0 に近づける（または 0 にする）と、環境によっては **候補の多様性が減り、極端に候補が少なく見える**ことがある。
- このとき、フィルタをONにすると「さらに候補が減った」ように見えやすい。

#### UIツールチップ案（そのまま使える文章）
> 難解PVフィルタは、解析で出た候補手から“見やすい手”だけを表示します。  
> 解析設定（探索数や wide root noise 等）によって候補手の数や多様性が変わります。  
> 候補が極端に少ない場合は、解析設定を見直してください（フィルタは手を生成できません）。

※ ここは「断定」ではなく「起こり得る」説明に留める（環境差があるため）。

---

## 10. 受け入れ条件（Acceptance Criteria）

- フィルタOFF: 現状と同じTop Moves表示
- フィルタON: Top Moves の候補手が減り、PVが短く/揺れが少ない傾向になる
- 最善手は info 側で常に参照可能（Top Movesに出ない場合があってもよい）
- AUTO は Viewer Preset 優先で動作し、適用中の強度がUIに表示される
- フィルタ結果が0件にならず、最低1手は表示される（フォールバック）
- 設定が保存され、再起動後も維持される

---

## 11. テスト方針（v1）

### 11.1 単体テスト（推奨）
- 疑似解析データ（候補手配列）を用意し、各レベルで:
  - 条件に合わない手が落ちる
  - 0件時のフォールバックが効く
  - AUTOマッピングが意図通り

### 11.2 手動確認
- 実棋譜で、フィルタOFF/WEAK/MEDIUM/STRONGの体感差がある
- wide root noise / visits を変えてもクラッシュせず、説明文が納得感を持つ

---

## 12. ロードマップ（この設計書の次）

### v1（まず入れる）
- 設定5択（OFF/WEAK/MEDIUM/STRONG/AUTO）
- レベル別パラメータ初期値
- フォールバック（最低1手）
- Best Move の別枠表示（info欄等）
- wide root noise 等へのツールチップ

### v2（必要なら）
- ヨセ判定による自動補正（例: STRONG→MEDIUM など）
- 解析の信頼度（visits等）に応じたAUTO調整（「不安定なら弱める」）
- 「候補が少ない理由」診断（設定ガイド）

---

## 付録A: 仕様決定ログ（任意）
- 「棋力低下は許容。学習体験を優先」
- 「最善手は info 側に残す」
- 「AUTO は Viewer 優先で安定化」
- 「wide root noise=0 で候補が極端に少なく見える可能性があるため、注意書きを必須」
