# MuZero 3分解（State / Policy / Transition）難解度 v1 設計書（用途限定版） v0.1

作成日: 2026-01-06  
ステータス: Draft（用途限定でv1を固める）  
対象: my-katrain（KaTrain v1.17.0 fork）

---

## 0. この文書の位置づけ（先に結論）

MuZero 3分解（State / Policy / Transition）は **「局面の難しさを断定する採点」ではなく、UI/学習フローを制御する“センサー”**として扱う。

v1では用途を **(1) 難所抽出** と **(2) 解説の出し分け** に限定する。  
Top Moves フィルタの強度自動調整などへの連動は、v1では **非対象（将来）** とする。

---

## 1. 背景と狙い

### 1.1 背景
- KataGo解析は高精度だが、人間の学習においては「迷いやすい局面」「一手で崩れる局面」「複雑で見通しが立ちにくい局面」の扱いが重要。
- 単一の難易度スコア（1本）だと、局面タイプ（ヨセ/攻め合い/定石）や学習目的により解釈がブレやすい。

### 1.2 狙い
- 「難しさ」を **性質ごとに分解**し、用途別に使い分けできるようにする。
  - Policy: 迷い（候補が拮抗）
  - Transition: 鋭さ/崩れやすさ（一手のミスが致命傷）
  - State: 盤面の複雑さ（v1では弱め、将来強化）

---

## 2. ゴール / 非ゴール

### 2.1 ゴール（v1でやる）
- 各局面に対して、以下を計算して保持できる:
  - `policy_difficulty`（0〜1）
  - `transition_difficulty`（0〜1）
  - `state_difficulty`（0〜1, v1は簡易）
  - `overall_difficulty`（0〜1, 合成値：用途限定）
- 上記を使って次を実現:
  1) **難所抽出**: 1局の中で「難所候補」を相対ランキングで抽出
  2) **解説の出し分け**: Viewer Preset（Lite/Standard/Deep）に応じて、どの性質をどう説明するかを切替

### 2.2 非ゴール（v1ではやらない）
- 難易度の絶対値で「この局面は難しい」と断定する（採点用途）
- 棋力評価・成績評価・段級位推定への直接利用
- 局面タイプ分類（ヨセ/攻め合い等）の自動判定（将来）
- エンジン設定（探索/ノイズ）を難易度で自動操作（将来）
- MuZeroの本来の学習過程の再現（本家の意味でのMuZero実装）

---

## 3. 用語

- **Candidate moves**: 解析が出す候補手（順位付き、PV付き）
- **Top1 / Top2**: 候補1位、2位
- **visits**: 探索数の目安（候補の信頼度に関わる）
- **score / winrate**: 評価値（どちらを使うかは実装で統一）
- **swing**: 一手で評価が大きく動く度合い（例: score_swing）

---

## 4. v1の基本方針（品質を落とさず実装可能にする）

### 4.1 「点数」ではなく「センサー」
- 値が0.73だから難しい、のような断定はしない。
- **同一棋譜内の相対比較**（上位N局面）を主用途にする。

### 4.2 解析条件の影響は前提にする
- visitsが少ない、ノイズ設定が強い、などで候補分布が変わる。
- v1では「不安定なときは難易度を“弱めに出す/不明扱い”」に寄せ、過剰な主張を避ける。

### 4.3 v1は Policy + Transition を主役、Stateは控えめ
- State（盤面複雑さ）は“それっぽさ”を出すのが難しいので、v1は軽い指標のみ（または0固定でも可）。
- 学習に効きやすいのは Policy（迷い）と Transition（崩れやすさ）。

---

## 5. 入出力（I/O契約）

### 5.1 入力（局面ごと）
- 解析済み候補手リスト（最低限）
  - 候補順位
  - 候補ごとの評価値（scoreまたはwinrate）
  - PV（手順）
  - visits（可能なら）
- （任意）局面のメタ情報
  - 手数（move number）
  - 次手番
  - komi / ルールなど

### 5.2 出力（局面ごと）
- `DifficultyMetrics`（名称は実装依存）
  - `policy_difficulty: float (0..1)`
  - `transition_difficulty: float (0..1)`
  - `state_difficulty: float (0..1)`
  - `overall_difficulty: float (0..1)`
  - `is_reliable: bool`（または reliability_score）
  - `debug_factors: dict`（任意。内訳の説明用）

---

## 6. 信頼度（Reliability）ガード

### 6.1 目的
- visitsが少ない/候補が少ない等で「分解値がブレる」状態を検知し、UIや抽出で過剰に使わない。

### 6.2 v1の簡易ルール案
- `is_reliable = (root_visits >= R)` かつ `(candidates >= C)`
  - R, C はv1で固定（例: R=500, C=5 など）。実値は運用で調整。
- unreliable の場合:
  - `overall_difficulty` は計算するが、**抽出の優先度を下げる**（または “不明” として扱う）
  - UIでは断定せず「解析が浅い可能性」を示す（将来）

---

## 7. 指標の定義（v1: できるだけ解析から取る）

> 注意: 以下は「定義」。実装では score / winrate のどちらを主にするかを決め、混在しないこと。

### 7.1 Policy Difficulty（迷い）
候補が拮抗しているほど「迷いやすい」。

v1の候補:
- **Top1-Top2差**（小さいほど難）
  - `gap = abs(score1 - score2)`（または winrate 差）
  - gap を 0..1 に正規化して反転（小さいほど1に近づく）
- **上位Nの分散/フラットさ**
  - 上位N候補の評価が団子（差が小さい）なら難
  - ただし v1 では Top1-Top2差だけでも効果が出やすい

#### v1採用案（推奨）
- policy = f(Top1-Top2差) を主
- 上位Nのフラットさは v2 以降

### 7.2 Transition Difficulty（崩れやすさ / 鋭さ）
一手のミスが致命的、読み筋が長くなりやすいほど難。

v1の候補:
- **最善以外の候補での損失の急増**（少し外すと急に悪化する）
  - Top1 と Topk の評価差が急に大きくなるほど難
- **score_swing（評価の振れ）**
  - その局面は「一手で評価が動きやすい」可能性
- **PV長**
  - 長すぎるPVは「読みが要る」サインになりやすい（ただしエンジン設定依存）

#### v1採用案（推奨）
- transition = g(Top1 と “現実的候補群” の落差) + h(score_swing)
- PV長は補助（軽い重み）

### 7.3 State Difficulty（盤面の複雑さ）
v1では最も不確実なので、控えめに扱う。

v1の候補（軽いもの）:
- **候補手の多さ**（有力候補が多い＝局面が広い）
- **上位候補のPV分岐の多様性**（将来）
- 石数・連結数などの盤面特徴（将来）

#### v1採用案（推奨）
- state = normalize(num_candidates)（上位N内で残る候補数など）
- もしくは state=0 でも可（v1はPolicy/Transitionで十分）

---

## 8. 正規化と合成（overall）

### 8.1 正規化
各成分は 0..1 に収める。  
閾値は「固定値」よりも、**同一棋譜内での分位（percentile）**で作るのが安定しやすい。

#### v1の現実案（おすすめ）
- v1はまず固定スケール（例: gapが0なら1、gapがX以上なら0）で開始
- 同時にログを取り、v2で棋譜内正規化に移行

### 8.2 合成（overall）
v1では用途限定なので、overallは **抽出と表示の優先度**にしか使わない。

#### v1の推奨重み
- overall = 0.45 * policy + 0.45 * transition + 0.10 * state

理由:
- 学習体験に直結するのが Policy/Transition
- Stateはv1では不確実なので控えめ

---

## 9. 用途1：難所抽出（v1）

### 9.1 目的
1局の中で「復習すべき局面」を見つける。

### 9.2 抽出ルール（推奨）
- 対象: 解析済み局面（手数帯は任意）
- スコア: overall_difficulty（ただし unreliable はペナルティ）
- 出力: 上位K局面（例: K=10〜30）

### 9.3 unreliable の扱い
- unreliable な局面はランキングから外す、またはスコアに減衰を掛ける（例: *0.7）
- UI上は「解析が浅い可能性」を示す（断定しない）

---

## 10. 用途2：解説の出し分け（Viewer Preset）

### 10.1 基本思想
Viewer Preset は「いまの理解しやすい粒度」。  
難解度は「何をどう説明すると良いか」を切り替えるセンサーとして使う。

### 10.2 具体方針（v1案）

#### Lite（要点重視）
- 出す情報:
  - overall（高/中/低の3段階ラベルでも可）
  - transition が高いときだけ短い注意（例: “一手で形勢が動きやすい”）
- 出さない:
  - 細かい分岐比較、長いPV解説

#### Standard（比較＋要点）
- 出す情報:
  - policy/transition のどちらが高いか（理由の方向性）
  - 候補手比較（Top1 vs Top2）を短く
- 例:
  - policy高: “候補が拮抗。違いはここ”  
  - transition高: “ミスが大きい。安全策はこれ”

#### Deep（分岐も許容）
- 出す情報:
  - policy/transition/state の内訳（ただし断定しない）
  - 代表的分岐を1〜2本（長すぎない）
- 注意:
  - Deepでも「難解すぎて学習が止まる」ことはあるので、文量は制御する（別仕様）

---

## 11. UI表示（主張を弱くする）

### 11.1 表示形式
- 「難しいです」ではなく「性質」を出す:
  - 迷いが大きい（Policy）
  - 一手で動きやすい（Transition）
  - 複雑（State）

### 11.2 ツールチップ案（そのまま使える文章）
> 難解度は“採点”ではなく、局面の性質（迷い・鋭さ・複雑さ）を推定する目安です。  
> 解析の深さ（探索数など）によって値が変わることがあります。  

---

## 12. 受け入れ条件（Acceptance Criteria）

- 難所抽出:
  - 1局から「納得感のある難所候補」が上位に来る（少なくとも“変化が大きい/迷いやすい”場面）
  - unreliable な局面が過剰に上位に来ない
- 解説出し分け:
  - Viewer Preset（Lite/Standard/Deep）で説明の量と焦点が変わる
  - 表現が断定にならない（目安/可能性の言い回し）
- ログ/デバッグ:
  - overallだけでなく policy/transition/state の内訳が追える（任意でも推奨）

---

## 13. v1→v2の拡張余地（参考）

- 棋譜内正規化（percentile）で安定化
- 局面タイプ（ヨセ/攻め合い）推定を加えて補正
- State難易度の強化（盤面特徴量・分岐多様性）
- フィルタAUTO等への“控えめ連動”（Transitionが極端に高い場合のみ1段階補助）

---

## 付録A: 設計判断のメモ
- v1は「用途限定」で成功させる（難所抽出＋解説出し分け）
- 採点・棋力評価に使わない（誤差が目立つ）
- Policy/Transitionを主役にし、Stateは控えめ
