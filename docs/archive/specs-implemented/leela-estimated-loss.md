# Leelaモード：推定損失（KataGo風）表示 v1 設計書 v1.0

作成日: 2026-01-06
更新日: 2026-01-15
ステータス: **実装完了**（Phase 14.0-14.7）
対象: my-katrain（KaTrain v1.17.0 fork）
前提: KataGoとは**完全分離**の「Leelaモード」を持つ（エンジン同梱なし、外部実行ファイル指定）

## 実装状況

| Phase | 内容 | 状態 |
|-------|------|------|
| 14.0 | lz-analyze出力サンプル収集 | ✅ 完了 |
| 14.1 | データ基盤（models/parser） | ✅ 完了 |
| 14.2 | 計算ロジック（logic.py） | ✅ 完了 |
| 14.3 | LeelaEngine実装 | ✅ 完了 |
| 14.4 | GameNode拡張 | ✅ 完了 |
| 14.5 | 設定項目実装 | ✅ 完了 |
| 14.6 | UI表示実装 | ✅ 完了 |
| 14.7 | 統合テスト + ドキュメント | ✅ 完了 |

**テスト**: 114 tests pass, 2 skipped (real engine tests)

---

## 1. 今回やること（結論）

Leela（`lz-analyze` 系を想定）の解析出力から、KataGoの **point loss（損失目数）に似た“見た目・役割”**を持つ指標を作る。

- 目的は **「投了判断の目安」** と **「候補手の差の可視化」**
- KataGoの期待得点（`scoreLead`）のような“正確な目差”を再現しない
- 値は **“推定 / 相対”** として扱い、断定表示を避ける
- 置碁でKataGoとズレるのは前提として許容し、注意文で補う

---

## 2. 背景（問題点）

- Leelaは強いが、UIが探索数（visits）中心だと「差の大きさ」が掴みにくい
- 勝率だけだと上下が激しく、特に置碁では体感（負けに入った）と一致しにくい
- 「候補手の○」を見た時に、訪問数だけでなく **“どれくらい損か”** が直感で分かる表示が欲しい
- 実用途は「精密な検証」ではなく、**対局中の判断（投了目安）**と、候補手の比較

---

## 3. ゴール / 非ゴール

### 3.1 ゴール（v1でやる）
- Leela候補手に対し、`推定損失`（estimated loss）を算出して表示する
- 盤上候補手マーカー（○）の視覚要素に推定損失を反映する
- 勝率バー/勝率グラフ（既存に近い形式）と並べて表示できる
- 置碁でも使える（ズレは許容し、誤認しないUIにする）

### 3.2 非ゴール（v1ではやらない）
- KataGoの損失目数と数値一致を目指す
- 期待得点（`scoreLead`/`scoreMean`）や ownership など高度な地合い推定の再現
- エンジン設定（探索/ノイズ）を推定損失で自動制御
- 「投了推奨」など強制的なアクション（あくまで目安）

---

## 4. UI方針（誤認を避けつつ、見た目は揃える）

### 4.1 表示名（重要）
KataGoの「損失目数」と混同されないよう、必ず **推定/相対**を含める。

- 表示名（推奨）: `推定損失` / `Loss (est.)` / `Rel loss`
- 列名（候補手テーブル）: `Loss (est.)`
- ツールチップ（固定文言案）:

> 推定損失は、Leelaの候補評価(%)の差を「目数っぽく」スケールした指標です。  
> KataGoの損失目数とは一致しない場合があります（置碁では特に差が出ることがあります）。

### 4.2 盤上候補手マーカー（○）の割り当て（推奨）
- ○のサイズ: 訪問数（visits）または割合（effort% / N%）
- ○の色/濃さ（または枠）: 推定損失（大きいほど悪い）
- ○の中の数字: 候補順位（1,2,3…）または visits（既存UIに合わせる）

### 4.3 “Leelaらしさ”の出し方（任意）
- 対局中は「候補差（損失）」と「探索量」の両方が欲しい
- そのため、候補手テーブルには `visits` 列も残す（KataGoと同じ列順でなくてよい）

---

## 5. データソースと I/O 契約

### 5.1 エンジン出力（想定）
`lz-analyze` 系の出力から以下を取得（最低限）：

- 候補手座標（例: `R6`）
- 候補手評価（%表記のいずれか）
- visits（訪問数）
- PV（変化）

補足：
- 実際の行フォーマットはエンジン/ビルドにより揺れるため、パーサは「複数パターン許容」を前提とする（実装段階で確定）。

### 5.2 内部データ構造（概念）
- `LeelaCandidate`
  - `move: str`（例: `"R6"`）
  - `eval_pct: float`（0..100）
  - `visits: int`
  - `pv: list[str]`
  - `loss_est: float`（0..、表示用）
- `LeelaPositionEval`
  - `winrate_pct: float`（0..100、表示用）
  - `score_est: float | None`（出せる場合のみ。例: `B+36.8` → `+36.8`）
  - `candidates: list[LeelaCandidate]`
  - `root_visits: int | None`（取れるなら）
  - `reliability: float`（0..1、任意）

---

## 6. 推定損失（estimated loss）の定義

### 6.1 基本思想
- v1は **候補手同士の相対差**が分かれば十分
- “目数っぽさ”はUIのためのスケールであり、厳密な地合ではない
- 置碁のズレを前提にし、**同一エンジン内の比較**を主用途にする

### 6.2 candidate_eval（候補評価%）の採用ルール
候補行に複数の%がある場合、v1は次の優先順で `eval_pct` を決める（実装で一本化）。

推奨優先順（ブレが少ない/一貫しやすい順に寄せる）：
1. `V:`（Value Network / NN eval 由来の%が候補ごとに取れるなら最優先）
2. `W:`（候補手の勝率%が候補ごとに出るなら採用）
3. その他（MCなど）※表示には使えるがブレが大きい場合がある

備考：
- どれが取れるかはビルド次第。取れたものを使う。
- v1では「使っているソース名」を隠してもOKだが、デバッグ用に表示できると後で便利（v1は任意）。

### 6.3 推定損失の計算（%差 → 目っぽい値）
候補手の評価%差を損失とし、表示用にスケールする。

- `best = max(eval_pct of candidates)`
- `loss_pct = best - eval_pct`（%ポイント差。ベスト手は0）
- `loss_est = loss_pct * K`

`K` は「目っぽく見せる係数」で、正確さより視認性を優先して良い。

#### Kの初期値（提案）
- `K = 0.5`（勝率差 10% → 5目っぽい）
- ユーザー設定で変更可能（例: 0.2〜1.5）
- 将来（v2）で「score差に切替できる」可能性を残す

### 6.4 表示丸め
- `loss_est < 0.05` → `0.0` 表示
- それ以外は小数1桁（例: `2.3`）

---

## 7. 信頼度（Reliability）と “投了目安” の扱い

### 7.1 なぜ必要か
- 勝率/推定値は探索が浅いと上下しやすい
- 特に置碁はキャリブレーションが崩れやすい

→ **一定の探索量を満たした時だけ**、投了目安など強い意味のUIを出す。

### 7.2 v1の簡易ルール
- `root_visits >= MIN_ROOT_VISITS` のときのみ「投了目安」を評価する  
  - 初期値例: `MIN_ROOT_VISITS = 15000`（環境により調整）

root_visits が取れない場合（ログに無い等）：
- `MIN_ROOT_VISITS` を満たした扱いにせず、投了目安は常にオフ（安全側）
- もしくは候補の visits 合計で代替（v1では任意、やるなら仕様化）

### 7.3 表示の平滑化（推奨）
投了判断は瞬間値より「安定して負け」を見たいので、表示側で平滑化する。

- `ema = alpha * current + (1-alpha) * ema_prev`
- 初期値例: `alpha = 0.2`

平滑化の対象候補：
- 画面上部の勝率バー（表示値）
- （出せる場合）score推定（表示値）

### 7.4 投了目安（v1案）
ユーザー意図：「負けに入ったからそろそろ投了するか」の目安

例（黒番/白番を気にせず使える条件）：
- `smoothed_winrate <= 5%` が一定期間（例: 3手 または 10秒）継続  
  かつ `root_visits >= MIN_ROOT_VISITS`

追加（可能なら）：
- `score_est` が取れる場合は `score_est <= -15.0`（自分視点で15目以上負け）を併用  
  ※v1では「取れれば使う」程度でOK

重要：
- 表示は「投了推奨」ではなく **投了目安**（ヒント）に留める
- ON/OFF可能にする（初期OFFでもOK）

---

## 8. 置碁（ハンデ戦）での扱い

### 8.1 方針
- 置碁では勝率や推定値がズレやすいことを前提にする
- ただし相対差（候補差）としては十分役に立つので機能は有効のまま

### 8.2 UI注意文（短文）
- 盤面上または設定画面の注意：

> 置碁では推定値がズレやすいことがあります（目安として利用してください）。

---

## 9. 設定項目（v1）

### 9.1 推定損失
- `Enable estimated loss`（ON/OFF）
- `Loss scale K`（0.2〜1.5、初期0.5）
- `Eval source`（auto / V / W / MC…）  
  - v1は `auto` 推奨
  - こだわる人向けに固定指定を許可（任意）

### 9.2 平滑化・投了目安
- `Enable smoothing`（ON/OFF、初期ON）
- `Smoothing alpha`（0.1〜0.4、初期0.2）
- `Enable resign hint`（ON/OFF、初期OFFでもOK）
- `Min root visits for resign hint`（初期15000）
- `Resign threshold winrate`（初期5%）
- `Resign stability window`（例: 3手 or 10秒）

---

## 10. 受け入れ条件（Acceptance Criteria）

### 10.1 機能
- 候補手一覧に `Loss (est.)` 列が表示される（ベスト手は0.0）
- 盤上候補手○の見た目で「損が大きい手」が直感的に分かる
- visitsだけ表示する場合に比べて「2番手との差」が分かりやすい

### 10.2 安定性
- root_visitsが少ないときに投了目安が暴れない（MIN_ROOT_VISITSでガード）
- 平滑化ONで勝率バーが極端にガタつかない

### 10.3 誤認防止
- 表示名に `推定/est.` が含まれる
- ツールチップで「KataGoと一致しない可能性」を明示する
- KataGoモードの `loss` 表示仕様には影響しない（完全分離）

---

## 11. テスト計画（v1）

### 11.1 手動テスト（最低限）
- 互先（コミあり/なし）で、候補手差が直感に合うか
- 置碁（3子など）で、ズレは出ても相対差として使えるか
- `K` を変えた時、見やすさが調整できるか
- 投了目安（ON時）が「浅い探索」で暴れないか

### 11.2 回帰観点
- KataGoモードの表示は一切変わらない（完全分離）
- エンジンが `eval_pct` を出さない場合：
  - 推定損失列は `--` 表示、または列自体を非表示
  - UIが壊れない（例外を出さない）

---

## 12. v2以降の拡張余地（参考）

- 候補手ごとの `score_est` が取れる場合は、推定損失を **%差ではなくスコア差**に切替（より“目っぽい”）
- 置碁・コミ条件に応じて `K` を自動補正（ただしやりすぎない）
- 難所抽出（MuZero 3分解）と連携し、投了目安ではなく「注意局面」表示に使う

---

## 付録A: 実装メモ（仕様側の注意）
- 解析出力はビルド差があるため、まず **サンプルログを2〜3種類**集めてパーサの対応範囲を決める
- 候補評価%の採用は v1で一本化し、UIに「どの値を使っているか」を表示できると調整が容易
- “それっぽさ”は `K` と表示丸めで作る（正確さより可用性優先）
