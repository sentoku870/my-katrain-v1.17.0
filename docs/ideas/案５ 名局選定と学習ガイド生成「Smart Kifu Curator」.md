---

# 仕様草案完全版: Phase 54-56 "Smart Kifu Curator" (名局選定と棋譜並べガイド)

## 1. コンセプト (UX Concept)

ユーザー体験は以下の3ステップで構成されます。

1.  **Selection (選抜):** ユーザーが「並べてみたい棋譜（例：秀策全集）」のフォルダをドラッグ＆ドロップ。
2.  **Ranking (格付け):** システムが「今のあなたの棋力なら、この局が最も学びが多く、理解しやすい」順にランキング表示。
3.  **Guide Generation (ガイド生成):** ベスト1の対局を選ぶと、KataGoの解析データを元にLLMが**「棋譜並べのしおり（Replay Companion Guide）」**を生成。ユーザーはそれを横に見ながら（実戦またはソフトで）石を並べる。

## 2. システムアーキテクチャ

### Phase 54: Curator Engine (選定・ランキング機能)

多数のSGFから「今学ぶべき一局」を選び出すロジックです。高速化のため、フル解析ではなく軽量解析を用います。

#### 2.1 評価指標: `SuitabilityScore` (適合度スコア)
各棋譜に対して以下のスコアを算出します。

$$Score = (Empathy \times 0.5) + (NeedsMatch \times 0.3) + (Quality \times 0.2)$$

1.  **Empathy (共感度/理解しやすさ):**
    *   **技術:** `Human-SL` モデル (Source) を使用。
    *   **ロジック:** ユーザーの目標ランク（例: `rank_1d`）のHuman-SLモデルで棋譜をスキャン。プロの着手とHuman-SLの予測（Policy Top 3）が一致する率が高いほど、「今のユーザーの棋力でも『なるほど』と理解できる手が多い」＝**並べていて苦痛じゃない**と判定します。
2.  **NeedsMatch (課題適合度):**
    *   **技術:** `RadarMetrics` (Source) と `MeaningTags` (Source)。
    *   **ロジック:** ユーザーのカルテで「Fighting（戦闘）」が弱点なら、その棋譜内で `fighting` や `semeai` タグが多く発生している局を高く評価します。「弱点を補う教材」を選びます。
3.  **Quality (簡明さ):**
    *   **ロジック:** `ScoreStdev`（局面の紛れ）が極端に高い「泥沼の乱戦」は学習効率が悪いため、ある程度「勝ち筋が明確（ScoreLeadが安定して推移）」な名局を優先します。

#### 2.2 実装クラス: `KifuCurator`
*   **入力:** SGFフォルダパス, ユーザープロファイル（現在のランク、弱点）
*   **処理:** バックグラウンドで高速スキャン（1局あたり数秒）。
*   **出力:** ランキングリスト（タイトル、適合度S〜C、推奨理由タグ）。

### Phase 55: Guide Data Extraction (データ抽出)

選ばれた「ベスト1」の棋譜に対し、ガイド生成に必要な「確実な根拠（Anchor）」をKataGoから抽出します。**LLMには棋譜全体を読ませず、以下の抽出データのみを渡します。**

#### 2.3 抽出データ構造: `ReplayGuideContext`
```json
{
  "game_title": "本因坊秀策 vs 太田雄蔵 (耳赤の一局)",
  "user_level": "野狐3段 (Aggressive Style)",
  "learning_theme": "「我慢」と「厚み」",
  "highlight_moments": [
    {
      "move_number": 35,
      "color": "Black",
      "location": "R4",
      "concept": "honte (本手)",
      "ai_insight": "AI評価値は横ばいだが、Human-SLの一致率が95%。味を消さずに守った、この碁のハイライト。",
      "why_good": "ここで反発せずにつないだことで、後の攻めが成立した。"
    },
    {
      "move_number": 127,
      "color": "Black",
      "location": "K10",
      "concept": "direction (大局観)",
      "ai_insight": "AI評価では+2目だが、盤面全体に響く『耳赤』の一手。"
    }
  ]
}
```
*   **ポイント:** 全ての手ではなく、`Phase 50: Critical 3` (Source) のロジックを応用し、**「学ぶべき3〜5か所の重要局面」**だけを抽出します。

### Phase 56: LLM Integration & UI (ガイド生成と表示)

#### 2.4 プロンプトエンジニアリング: "The Replay Coach"
LLM（Claude/GPT）への指示書です。「棋譜並べ」という行為を支援する人格を与えます。

> **System Prompt:**
> あなたはプロの囲碁インストラクターです。
> ユーザーはこれから、選定されたプロの棋譜を盤に並べて学習します。
> 提供されたJSONデータを元に、ユーザーが手元に置いて参照するための**「棋譜並べガイド（Replay Guide）」**を作成してください。
>
> **ガイドの構成ルール:**
> 1.  **導入:** なぜこの一局が今のユーザー（[user_level]）に選ばれたのか、一言でモチベーションを上げてください。
> 2.  **チェックポイント:** 棋譜全体を解説する必要はありません。JSONにある`highlight_moments`の局面（手数）に来たら手を止めて考えるよう、指示してください。
> 3.  **問いかけ:** 答えを教える前に、「あなたならどこに打ちますか？」と問いかけてください。
> 4.  **用語:** 専門用語（本手、サバキなど）には、初心者にもわかる短い補足を付けてください。

#### 2.5 ユーザーインターフェース: "Side-by-Side View"
*   **左側:** SGFプレイヤー（自動再生ではなく、ユーザーがクリックして進める、または実戦で並べるための譜面表示）。
*   **右側:** 生成された「ガイド（Markdown）」。
    *   スクロール連動：棋譜が35手目に達すると、ガイドの「第35手の解説」がハイライトされる。

## 3. 出力されるガイドのイメージ (Markdown)

ユーザーには以下のようなドキュメントが提示されます。

```markdown
# 📖 本日の学習：秀策の「厚み」を体感する

**選定理由:**
あなたは「戦闘（Fighting）」が得意ですが、攻めすぎて自滅する傾向があります。
この対局（秀策 vs 太田）は、無理に攻めずに**「本手（Honte）」**で待ち構えることで勝つ、最高の手本です。

---

### 🛑 チェックポイント 1: 第35手（黒番）
**（ここで手を止めて考えてみましょう）**

左下で白が激しく動いてきました。あなたの棋風だと、ここで「反撃」したくなるかもしれません。
しかし、秀策はここでどう打ったでしょうか？

*   **ヒント:** 攻めるのではなく、自分の傷をなくす手です。
*   **着手:** **R4（ツギ）**
*   **解説:** これが **「本手（Honte）」** です。地味ですが、ここで厚く打ったことが、100手後の戦いで効いてきます。この「待ちの感覚」を味わってください。

---

### 🛑 チェックポイント 2: 第127手（黒番）
...
```

## 4. ロードマップへの配置

`01-roadmap.txt` の Phase 53 以降を以下のように確定します。

*   **Phase 54: Curator Backend (Ranking Engine)**
    *   Human-SLとRadarMetricsを用いたSGFバッチ評価ロジックの実装。
*   **Phase 55: Guide Context Builder**
    *   選定された1局から「Critical Moments」を抽出し、LLM用JSONを構築するパイプライン。
*   **Phase 56: Curator UI & LLM Connection**
    *   SGFフォルダインポート画面、ランキングリスト、そして「ガイド表示モード」の実装。

この設計であれば、LLMに「1局すべての厳密な解説」という無理なタスクを負わせることなく、KataGoの正確な数値と、LLMの教育的な語り口を組み合わせた、**「並べるための参考資料」**として最高品質のものを提供できます。