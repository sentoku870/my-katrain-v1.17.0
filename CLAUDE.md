# CLAUDE.md - myKatrain PC版 開発ガイド

> このファイルはClaude Codeがプロジェクトを理解するための主要ドキュメントです。
> 補助ルールは `.claude/rules/` を参照してください。

---

## 1. プロジェクト概要

### 1.1 基本情報
- **プロジェクト名**: myKatrain（KaTrain fork）
- **技術スタック**: Python 3.9+ / Kivy（GUI）/ KataGo（解析エンジン）
- **リポジトリ**: `sentoku870/my-katrain-v1.17.0`
- **ローカルパス**: `D:\github\katrain-1.17.0`

### 1.2 目的（1文）
KataGo解析を元に「カルテ（Karte）」を生成し、LLM囲碁コーチングで的確な改善提案を引き出す。

### 1.3 現在のフェーズ
- **完了**: Phase 1-4（解析基盤、重要局面、ミス分類、クイズ基盤）
- **完了**: Phase 4.5（eval_metrics安定化）
- **次**: Phase 5（1局カルテ安定出力）

詳細は `docs/01-roadmap.md` を参照。

---

## 2. ユーザー（sentoku870）のスキルと期待

### 2.1 スキルレベル
| 領域 | レベル | 備考 |
|------|--------|------|
| PC操作 | 中〜上級 | 手順があれば複雑な操作も実行可能 |
| プログラミング | 初心者 | Progate Python基礎程度、コードは読めるが書けない |
| Git/GitHub | 基本操作可 | 手順通りの操作は可能 |
| 囲碁 | 野狐4-5段 | ドメイン知識は十分 |

### 2.2 期待する対応
- **コード変更**: 原則 Claude Code で実行（手動編集は最小限）
- **説明**: 専門用語は初出時に1-2文で定義
- **手順**: コピペで完結する具体的なコマンドを提示
- **確認**: 動作確認ポイントを明示

### 2.3 作業の快適さ優先順位
1. **最優先**: 自分だけで動作ロジック修正をしない
2. **可能**: GPT/Claude指示ありの最小修正（タイポ、数値調整）
3. **許容**: ファイル全体のコピペ差し替え
4. **避けたい**: 複数ファイルの整合性判断

---

## 3. 開発ルール（必須）

### 3.1 修正レベルの判定（簡易版）

| Lv | 規模 | 対応方法 |
|:--:|------|----------|
| 0 | 超軽微（コメント/文言） | Claude Code で直接修正 |
| 1 | 軽微（〜50行、1ファイル） | Claude Code で直接修正 |
| 2 | 中程度（〜100行、1-2ファイル） | Plan Mode → 承認 → 実行 |
| 3 | 複数ファイル（2-3ファイル） | Plan Mode + 段階的実行 |
| 4 | 大規模（4ファイル超） | 分割案を先に提示 |
| 5 | 根本変更 | 設計相談のみ（実装保留） |

詳細は `.claude/rules/01-correction-levels.md` を参照。

### 3.2 Git ワークフロー（簡易版）

```
code-change（コード修正を含む）:
  → ブランチ: feature/YYYY-MM-DD-<short-desc>
  → PR経由でmainにマージ

docs-only（ドキュメントのみ）:
  → main直接コミット可
```

詳細は `.claude/rules/02-git-workflow.md` を参照。

### 3.3 動作確認（必須）
- **起動確認**: `python -m katrain`
- **テスト**: `uv run pytest tests`
- **UTF-8強制**（PowerShell）: `$env:PYTHONUTF8 = "1"`

---

## 4. コード構造（概要）

```
katrain/
├── __main__.py      ← アプリ起動、KaTrainGui クラス
├── core/
│   ├── game.py       ← Game クラス（対局状態）
│   ├── game_node.py  ← GameNode（手/解析結果）
│   ├── engine.py     ← KataGoEngine（解析プロセス）
│   └── eval_metrics.py ← 重要局面/ミス分類（Phase1-4で追加）
├── gui/
│   ├── controlspanel.py ← 右パネル
│   ├── badukpan.py      ← 盤面表示
│   └── widgets/
│       └── graph.py     ← ScoreGraph
├── gui.kv            ← Kivy レイアウト定義
└── i18n/             ← 翻訳ファイル
```

### データフロー
```
KataGo(JSON) → KataGoEngine → GameNode.set_analysis()
           → KaTrainGui.update_state() → UI更新
```

詳細は `docs/02-code-structure.md` を参照。

---

## 5. 囲碁ドメイン（参照）

### 5.1 棋力レベル定義
| ラベル | 目安 | 説明 |
|:------:|------|------|
| G0 | 〜10級 | ルール〜基本死活 |
| G1 | 5〜1級 | 一般級位者 |
| G2 | 初段〜二段 | 基本形理解あり |
| G3 | 三〜四段 | 戦い強いがムラあり |
| G4 | 五段相当 | ユーザー本人 |

### 5.2 解説レベル定義
| ラベル | 説明 |
|:------:|------|
| A | 方向性だけ伝えるヒント |
| B | 石の役割・構図まで触れる |
| C | プロ並みの構想説明（重い） |
| D | KataGo並みの詳細（非現実的） |

詳細は `.claude/rules/04-go-domain.md` を参照。

---

## 6. 技術選定の判断基準（4軸）

新機能/設計変更時は以下で判断：

| 軸 | A | B | C |
|----|---|---|---|
| 対象範囲 | 局所機能 | 画面単位 | アプリ全体 |
| 継続性 | 実験/一時的 | 中期（数ヶ月） | 長期（標準機能） |
| 精度要求 | ざっくり | ある程度信頼 | かなり正確 |
| 自動化 | 手動中心 | 半自動 | ほぼ全自動 |

迷ったら **B案（標準構成）** を採用。

---

## 7. やらないこと（non-goals）

- 外部APIへの自動送信（LLM連携は手動添付）
- フル機能SGFエディタ化
- 大規模な棋譜管理DB
- 対局支援（チート用途）
- 「最善手当てクイズ」を目的化した訓練

---

## 8. 出力時の注意

### 8.1 回答フォーマット（推奨）
```
1. 今回やること（1-2文）
2. 修正レベル（Lv0-5）
3. 変更ファイル
4. 手順（コマンド付き）
5. 動作確認ポイント
```

### 8.2 記号の使い分け
- 囲碁解説レベル: `解説=A〜D`
- 技術選定4軸: `軸(対象範囲)=A〜C`
- 採用案: `案=A案/B案/C案`

---

## 9. ドキュメント配置

```
docs/
├── 00-purpose-and-scope.md  ← 目的とスコープ（固定）
├── 01-roadmap.md            ← ロードマップ（更新可）
├── 02-code-structure.md     ← コード構造（参照）
└── 99-worklog.md            ← 作業履歴

.claude/rules/
├── 01-correction-levels.md  ← 修正レベル詳細
├── 02-git-workflow.md       ← Git操作詳細
├── 03-debug-workflow.md     ← デバッグ手順
└── 04-go-domain.md          ← 囲碁ドメイン詳細
```

---

## 10. 変更履歴

- 2025-12-30: v1.0 作成（Claude Code移行対応）
